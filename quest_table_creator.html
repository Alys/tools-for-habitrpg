<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Habitica Wiki Quest Table Creator</title>

<!--

This page outputs the wikia code for creating the Quest Table
in this page:
    http://habitica.wikia.com/wiki/ XXX

This code is licenced under the same terms as Habitica:
    https://raw2.github.com/HabitRPG/habitrpg/develop/LICENSE

https://github.com/Alys/tools-for-habitrpg/blob/master/quest_table_creator.html

https://oldgods.net/habitrpg/quest_table_creator.html

Contributors:
    Alys (Alice Harris), lady_alys@oldgods.net

-->

    <meta name="description" content="Habitica Wiki Quest Table Creator" />
    <meta name="author" content="Alys (Alice Harris) lady_alys@oldgods.net" />


    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="//cdn.datatables.net/1.10.10/js/jquery.dataTables.min.js"></script>
    <link href="//cdn.datatables.net/1.10.10/css/jquery.dataTables.min.css" rel="stylesheet" type="text/css" />


<script type="text/javascript">
$(function() { // wraps around all our code to not pollute global namespace

var wikiaBaseUrl = 'http://habitica.wikia.com/wiki/';


//////////////////////////////////////////////////////////////////////
////   SCROLL IMAGE FILE NAMES FOR EACH QUEST          ///////////////
////                                                   ///////////////
////   Add new entries here (in any order) when a new  ///////////////
////   quest becomes available.                        ///////////////
////   This is necessary only if the wiki image links  ///////////////
////   for the quest scroll do not match the file      ///////////////
////   names from Habitica.                            ///////////////
////                                                   ///////////////
////   DO NOT PUT SPACES IN THESE FILE NAMES!          ///////////////
//////////////////////////////////////////////////////////////////////
var images = {
    'evilsanta':  'Inventory_quest_scroll_evilsanta.png',
    'burnout':     'n/a',
    'stressbeast': 'n/a',
    'dilatory':    'n/a',
};

//////////////////////////////////////////////////////////////////////
////   AVAILABILITY TEXT FOR **SOME** QUESTS           ///////////////
////                                                   ///////////////
////   Add new entries here (in any order) when        ///////////////
////   a new quest becomes available if and only if    ///////////////
////   its availability is not the standard            ///////////////
////   "permanent".                                    ///////////////
//////////////////////////////////////////////////////////////////////
var questAvailability = {
    'basilist':    'invite to party',
    'egg':         'only during ' + make_url('Spring Fling'),
    'evilsanta':   'only during ' + make_url('Winter Wonderland'),
    'evilsanta2':  'only during ' + make_url('Winter Wonderland'),
    'burnout':     'finished<br />('+ make_url('Fall Festival 2015','Fall_Festival') +')',
    'stressbeast': 'finished',
    'dilatory':    'finished',
};

//////////////////////////////////////////////////////////////////////
////   WIKI LINKS FOR **SOME** QUESTS                  ///////////////
////                                                   ///////////////
////   Add new entries here (in any order) when        ///////////////
////   a new quest becomes available.                  ///////////////
////   This is necessary only if the wiki page         ///////////////
////   filename does not match the filename that can   ///////////////
////   be created automatically from the quest's name. ///////////////
////                                                   ///////////////
////   DO NOT PUT SPACES IN THESE LINKS!               ///////////////
//////////////////////////////////////////////////////////////////////
var questPageUrls = {
    'atom1' : 'Dish_Disaster',
    'atom2' : 'The_SnackLess_Monster',
    'atom3' : 'The_Laundromancer',
    'goldenknight1' : 'A_Stern_Talking-To',
    'goldenknight2' : 'Gold_Knight',
    'goldenknight3' : 'The_Iron_Knight',
    'moonstone1' : 'The_Moonstone_Chain',
    'moonstone2' : 'Recidivate_the_Necromancer',
    'moonstone3' : 'Recidivate_Transformed',
    'vice1' : 'Free_Yourself_of_the_Dragon\'s_Influence',
    'vice2' : 'Find_the_Lair_of_the_Wyrm',
    'vice3' : 'Vice_Awakens',
    'dilatoryDistress1' : 'Message_in_a_Bottle',
    'dilatoryDistress2' : 'Creatures_of_the_Crevasse',
    'dilatoryDistress3' : 'Not_a_Mere_Maid',
    'evilsanta2' : 'Find_the_Cub',
};

//////////////////////////////////////////////////////////////////////
////   LINKS FOR REWARDS (GEAR, ETC)                   ///////////////
////                                                   ///////////////
////   Add new entries here (in any order) when        ///////////////
////   a quest rewards you with equipment AND when     ///////////////
////   that equipment has its own wiki page.           ///////////////
////                                                   ///////////////
////   DO NOT PUT SPACES IN THESE LINKS!               ///////////////
//////////////////////////////////////////////////////////////////////
var rewardPageUrls = {
    'shield_special_goldenknight': 'Mustaine%27s_Milestone_Mashing_Morningstar',
    'weapon_special_2': 'Stephen_Weber%27s_Shaft_of_the_Dragon',
    'head_special_2': 'Nameless_Helm',
    'armor_special_2': 'Jean_Chalard%27s_Noble_Tunic',
};

//////////////////////////////////////////////////////////////////////
////   RELEASE DATES FOR QUEST SCROLLS                 ///////////////
//////////////////////////////////////////////////////////////////////
var startOfTime = '2015-11';
var releaseDates = {
    'dilatory': startOfTime,
    'stressbeast': startOfTime,
    'burnout': startOfTime,
    'evilsanta': startOfTime,
    'evilsanta2': startOfTime,
    'gryphon': startOfTime,
    'hedgehog': startOfTime,
    'ghost_stag': startOfTime,
    'vice1': startOfTime,
    'vice2': startOfTime,
    'vice3': startOfTime,
    'egg': startOfTime,
    'rat': startOfTime,
    'octopus': startOfTime,
    'dilatory_derby': startOfTime,
    'atom1': startOfTime,
    'atom2': startOfTime,
    'atom3': startOfTime,
    'harpy': startOfTime,
    'rooster': startOfTime,
    'spider': startOfTime,
    'moonstone1': startOfTime,
    'moonstone2': startOfTime,
    'moonstone3': startOfTime,
    'goldenknight1': startOfTime,
    'goldenknight2': startOfTime,
    'goldenknight3': startOfTime,
    'basilist': startOfTime,
    'owl': startOfTime,
    'penguin': startOfTime,
    'trex': startOfTime,
    'trex_undead': startOfTime,
    'rock': startOfTime,
    'bunny': startOfTime,
    'slime': startOfTime,
    'sheep': startOfTime,
    'kraken': startOfTime,
    'whale': startOfTime,
    'dilatoryDistress1': startOfTime,
    'dilatoryDistress2': startOfTime,
    'dilatoryDistress3': startOfTime,
    'cheetah': startOfTime,
    'horse': startOfTime,
    'frog': startOfTime,
    'snake': startOfTime,
    'unicorn': '2015-12',
    'sabretooth' : '2016-01',
};
// get the current month's date in case the latest quest
// hasn't been added above yet:
var d = new Date();
var month = d.getMonth() + 1;
var thisMonth = d.getFullYear() + '-' + ((month < 10) ? '0' : '') + month;


//////////////////////////////////////////////////////////////////////
////   Global Variables                              /////////////////
//////////////////////////////////////////////////////////////////////
var content; // holds site-wide content (gear names and stats, quests, etc)


//////////////////////////////////////////////////////////////////////
////   Global Connection Variables      //////////////////////////////
//////////////////////////////////////////////////////////////////////
var serverName        = 'Habitica'; // used in "loading" message
var serverUrl         = 'https://habitica.com:443/api/v2';
var serverPathContent = '/content';
var serverPathUser    = '/user';
var userId            = '';
var apiToken          = '';

/* TST - FOR TESTING:
$('body').css({'background-color':'#C4B4A4'});
serverName        = 'localhost';
serverUrl         = 'http://localhost';
serverPathContent = '/cgi-bin/hrpg_content.pl';
*/


//////////////////////////////////////////////////////////////////////
////   Data Fetch Function   /////////////////////////////////////////
//////////////////////////////////////////////////////////////////////
fetchData();
function fetchData() {
    $('#loading #serverName').text(serverName);
    $('#loading .good').show();
    $('#loading .bad' ).hide();

    // fetch the site-wide content (quest names and stats, etc):
    $.ajax({
        url: serverUrl + serverPathContent,
        type: 'GET',
        dataType: 'json',
        cache: true,
        success: fetchContentSuccess,
        error: fetchFailure
    });

    function fetchFailure() {
        $('#loading .good').hide();
        $('#loading .bad' ).show();
    }
    function fetchContentSuccess(data) {
        content = data;
        parseData();
    }
}

function parseData() {
    var allQuests = content.quests;

    // Get quest IDs and sort them in the desired display order
    // (world bosses at end because of least interest):
    var questIds    = [];
    var questIdsEnd = [];
    for (var questId in allQuests) {
        var quest = allQuests[questId];
        if (quest.category && quest.category === 'world') {
            questIdsEnd.push(questId);
        }
        else {
            questIds.push(questId);
        }
    }
    questIds = questIds.concat(questIdsEnd);

    var warnings = '';

    var headers = [ ' class="unfilterable" | name',
                    ' class="unfilterable" | scroll',
                    ' class="unfilterable" | availability',
                    ' class="unsortable"   | type',
                    ' class="unfilterable" | rewards',
                    ' class="unfilterable" | GP',
                    ' class="unfilterable" | XP',
                    ' class="unfilterable" | boss<br />HP',
                    ' class="unfilterable" | boss<br />strength'];

    var headersHtml = ['name', 'scroll', 'availability', 'type', 'rewards', 'GP', 'XP', 'boss HP', 'boss strength'];
    headersHtml.push('<em>length</em>', '<em>difficulty</em>', '<em>rating</em>', '<em>release date</em>');
    var includeQuestId = true;
    var includeQuestId = false;
    if (includeQuestId) { headersHtml.push('<em>quest ID</em>'); }

    // table row for each quest:
    var releaseDateNeeded = '';
    var tableRows    = { 'all':        [],
                         'easy':       [],
                         'medium':     [],
                         'hard':       [],
                         'questLines': [],
                       };
    var tableRowsHtml    = [];
    var devData = '';
    var latestQuestUpdatesNeeded = '';
    for (var index = 0; index < questIds.length; index++) {
        var questId = questIds[index];
        var quest = allQuests[questId];
        // devData += "    '" + questId + "': startOfTime,\n";
        var row     = [];

        var questName = quest.text.replace(/^The /, '');
        row.push([ make_url(quest.text, questPageUrls[questId] || ''),
                   'data-sort-value="' + questName + '"' ]);

        row.push([ make_image(images[questId] ||
                             'Inventory_quest_scroll_' + questId + '.png',
                             questId),
                  'data-sort-value="' + questId + '"' ]);

        var availability = '';
        var displayLevelRestriction = false;
        if (quest.category && quest.category === 'unlockable') {
            if (quest.previous) {
                availability = 'previous part';
                displayLevelRestriction = quest.lvl; // true
            }
            else if (quest.lvl) {
                availability = 'level ' + quest.lvl;
            }
        }
        if (quest.unlockCondition && quest.unlockCondition.condition &&
            quest.unlockCondition.condition === 'party invite'
           ) {
            delete quest.value; // Habitica's config lies
        }
        var cost = (quest.goldValue) ? quest.goldValue + ' GP' :
                   (quest.value)     ? quest.value + ' gem' +
                                       ((quest.value > 1) ? 's' : '' )
                                     : '';
        if (cost) {
            if (availability) {
                availability += ' or<br />';
            }
            availability += cost;
        }
        if (questAvailability[questId]) {
            if (availability) {
                availability += '<br />';
            }
            availability += questAvailability[questId];
        }
        if (displayLevelRestriction) {
            availability += '<br />(level ' + quest.lvl + ')';
        }
        row.push(availability);

        var objectiveType =
            (quest.category && quest.category === 'world') ? 'world boss' :
            (quest.collect) ? 'collection' :
            (quest.boss)    ? 'boss' :
                              'unknown';
        row.push(objectiveType);

        var droppedGP = quest.drop.gp || 0;
        var droppedXP = quest.drop.exp || 0;
        delete quest.drop.gp;
        delete quest.drop.exp;

        // if (quest.drop.unlock) { console.log(quest.drop.unlock); } // TST
        delete quest.drop.unlock;

        var items = {};
        if (quest.drop.items) {
            for (var i in quest.drop.items) {
                var obj = quest.drop.items[i];
                if (!items[obj.type]) {
                    items[obj.type] = {}; // e.g., "eggs", "gear"
                }
                if (!items[obj.type][obj.key]) {
                    items[obj.type][obj.key] = {}; // e.g., Potatoe
                }
                items[obj.type][obj.key]['text'] = obj.text; // e.g., Potato
                if (!items[obj.type][obj.key]['count']) {
                    items[obj.type][obj.key]['count'] = 0;
                }
                items[obj.type][obj.key]['count']++;
                delete obj.type;
                delete obj.key;
                delete obj.text;
                if (Object.keys(obj).length) {
                    console.log('"obj" object has other contents:');
                    console.log(obj);
                }
            }
        }
        delete quest.drop.items;
        if (Object.keys(quest.drop).length) {
            console.log('"quest.drop" object has other contents:');
            console.log(quest.drop);
        }

        var petName   = '';
        var mountName = '';
        var equipment = [];
        var other     = [];
        for (var type in items) {
            if (type === 'food' && quest.category === 'world') {
                other.push("one of each food"); // ASSUME this happens for each world quest
            }
            else {
                for (var key in items[type]) {
                    var text = items[type][key]['text'];
                    if (type === 'pets') {
                        // ASSUME this key doesn't appear in rewardPageUrls
                        // ASSUME there's no more than one pet
                        petName = text.replace(/ +\(Pet\)/i, '');
                    }
                    else if (type === 'mounts') {
                        // ASSUME this key doesn't appear in rewardPageUrls
                        // ASSUME there's no more than one mount
                        mountName = text.replace(/ +\(Mount\)/i, '');
                    }
                    else {
                        if (type === 'gear') {
                            text = text.replace(/ +\((Shield-hand Weapon|Armor|Headgear|Weapon|Shield-Hand Item)\)/i, '');
                        }
                        else if (type === 'eggs') {
                            text = text.replace(/\(Egg\)/i, '(egg)');
                        }
                        else if (type === 'hatchingPotions') {
                            text = text.replace(/Hatching Potion/i, 'hatching potion');
                        }
                        if (rewardPageUrls[key]) {
                            text = make_url(text, rewardPageUrls[key]);
                        }
                        if (items[type][key]['count'] > 1) {
                            text += ' x ' + items[type][key]['count'];
                        }
                        if (type === 'gear') {
                            equipment.push(text);
                        }
                        else {
                            other.push(text);
                        }
                    }
                }
            }
        }

        if (petName && mountName && petName === mountName) {
            var pets = petName + ' (pet &amp; mount)';
            other.unshift(pets);
        }
        else {
            if (petName) {
                other.unshift(petName + ' (pet)');
            }
            if (mountName) {
                other.unshift(mountName + ' (mount)');
            }
        }
        var rewardItems = equipment.concat(other);

        var specialRewardType = 'unknown';
        var etcPossible = false;
        var dropsScroll = false;
        if (questId === 'basilist') {
            specialRewardType = 'XP, GP<br />only';
        }
        if (items['gear']) {
            specialRewardType = 'equipment';
            etcPossible = true;
            delete items['gear'];
        }
        if (items['quests']) {
            dropsScroll = true;
            specialRewardType = 'scroll';
            etcPossible = true;
            delete items['quests'];
        }
        if (etcPossible && Object.keys(items).length) {
            specialRewardType += ', etc';
        }
        var rewardType =
            (!quest.category)                 ? specialRewardType :
            (quest.category === 'world')      ? 'various' :
            (quest.category === 'gold')       ? specialRewardType :
            (quest.category === 'unlockable') ? specialRewardType :
                                                quest.category; // e.g., pet

        // add list of rewards to reward type, with some abbreviations:
        var itemsString = rewardItems.join(';<br />');
        if (rewardType === 'scroll') {
            itemsString = itemsString.replace(/ \(Scroll\)/i, '');
            itemsString = itemsString.replace(/ \(Quest Scroll\)/i, '');
            itemsString = itemsString.replace(/.*Part [0-9]: /i, '');
        }

        if (itemsString) {
            rewardType += ':<br />' + itemsString;
        }

        row.push(rewardType);

        row.push(droppedGP);
        row.push(droppedXP);

        var bossHP     = 'n/a';
        var bossHPSort = 0;
        var bossStr    = 'n/a';
        var bossRage   = '';
        var questLength         = 'n/a';
        var questLengthDetailed = 'n/a';
        var questDifficulty     = 'n/a';
        if (quest.boss) {
            bossHP     = quest.boss.hp   || 0;
            bossHPSort = bossHP;
            bossStr  = quest.boss.str  || 0;
            bossRage = (quest.boss.rage && quest.boss.rage.value) ? +quest.boss.rage.value : 0;
            if ((!quest.category || quest.category !== 'world')) {
                if (bossHP > 999) {
                    questLength = '3. long';
                }
                else if (bossHP > 499) {
                    questLength = '2. medium';
                }
                else {
                    questLength = '1. short';
                }

                if (bossHP > 1200) {
                    questLengthDetailed = '> 4 wk';
                }
                else if (bossHP > 1000) {
                    questLengthDetailed = '~ 4 wk';
                }
                else if (bossHP > 900) {
                    questLengthDetailed = '3-4 wk';
                }
                else if (bossHP > 799) {
                    questLengthDetailed = '~ 3 wk';
                }
                else if (bossHP > 500) {
                    questLengthDetailed = '2-3 wk';
                }
                else if (bossHP > 400) {
                    questLengthDetailed = '~ 2 wk';
                }
                else if (bossHP > 300) {
                    questLengthDetailed = '< 2 wk';
                }
                else {
                    questLengthDetailed = '~ 1 wk';
                }

                if (bossStr > 2.5) {
                    questDifficulty = '5. very hard';
                }
                else if (bossStr === 2.5) {
                    questDifficulty = '4. hard';
                }
                else if (bossStr >= 2) {
                    questDifficulty = '3. medium';
                }
                else if (bossStr >= 1.5) {
                    questDifficulty = '2. easy';
                }
                else {
                    questDifficulty = '1. trivial';
                }
            }

            var divisor = 1000 * 1000;
            if (bossHP > divisor) {
                bossHP = bossHP / divisor;
                bossHP += 'M';
            }
            if (bossRage && bossRage > divisor/10) {
                bossRage = bossRage / divisor;
                bossRage += 'M';
            }
        }
        else if (quest.collect) {
            var count = 0;
            for (var i in quest.collect) {
                if (quest.collect[i].count) {
                    count += quest.collect[i].count;
                }
            }

            if (count > 300) {
                questDifficulty = '5. very hard';
                questLength = '3. long';
                questLengthDetailed = '';
            }
            else if (count > 100) {
                questDifficulty = '4. hard';
                questLength = '3. long';
                questLengthDetailed = '';
            }
            else if (count > 30) {
                questDifficulty = '3. medium';
                questLength = '2. medium';
                questLengthDetailed = '';
            }
            else {
                questDifficulty = '2. easy';
                questLength = '1. short';
                questLengthDetailed = '';
            }
        }

        var rating = 'unknown';
        if (quest.category && quest.category === 'world') {
            rating = '4. n/a';
        }
        else if ((questDifficulty === '1. trivial' ||
             questDifficulty === '2. easy') && questLength === '1. short'
           ) {
            rating = '1. easy';
        }
        else if ( questDifficulty >= '4. hard' ||
                 (questDifficulty === '3. medium' && questLength === '3. long')
                ) {
            rating = '3. hard';
        }
        else {
            rating = '2. medium';
        }

        row.push([ bossHP + ((bossRage) ? '<br />rage:'+bossRage : ''),
                   'data-sort-value="' + bossHPSort + '"' ]);
        row.push(bossStr);

        var myRegexpLink  = /(.*)\[(\S+) +([^\]]+)\](.*)/g;            // '[' + url + ' ' + text + ']';
        var myRegexpImage = /(.*)\[\[File:([^\|]+)\|[^\]]+\]\](.*)/g;  // '[[File:' + image + '|' + hoverText + ']]';

        // So far, row contains the table cells for a Wikia table.
        // We now create an HTML version, and then add more fields to that.
        var rowHtml = [];
        for (var i in row) {
            var valueObj = row[i];
            var value  = '';
            if (Object.prototype.toString.call(valueObj) === '[object Array]') {
                value  = valueObj[0];
                // ignore second element which is a wikia table config string
            }
            else {
                value = valueObj;
            }

            // replace Wikia links and images with HTML versions (we ASSUME there's at most ONE link and ONE image per table cell):
            var match = myRegexpLink.exec(value);
            if (match) {
                value = match[1] + '<a href="' + match[2] + '">' + match[3] + '</a>' + match[4];
            }
            var match = myRegexpImage.exec(value);
            if (match) {
                value = match[1] + '<img src="' + 'fake_broken_image' + '" />' + match[3]; // no image because it won't work anyway
            }

            rowHtml.push(value);
        }

        rowHtml.push(questLength + ((questLengthDetailed) ?
                    '<br />(' + questLengthDetailed + ')' : ''));
        rowHtml.push(questDifficulty);
        rowHtml.push(rating);

        var releaseDate       = '';
        var releaseDatePretty = '';
        if (! releaseDates[questId]) {
            releaseDateNeeded += "'" + questId +"' : '"+ thisMonth + "',<br />";
        }
        releaseDate = releaseDates[questId] || thisMonth;
        // var myRegexp = /(.+)-0?(.+)/g; // year-month
        // var match = myRegexp.exec(releaseDate);
        if (releaseDate === startOfTime) {
            // releaseDatePretty = 'before<br />Dec 2015';
            releaseDatePretty = releaseDate + '<br />or earlier';
        }
        // else if (match) {
            // var months = ['zero','Jan','Feb','Mar','Apr','May','Jun',
                                 // 'Jul','Aug','Sep','Oct','Nov','Dec'];
            // var monthNumber = match[2];
            // var month = months[match[2]] || match[2];
            // releaseDatePretty = month + '<br />' + match[1];//year
        // }
        else {
            releaseDatePretty = releaseDate;
        }
        rowHtml.push(releaseDatePretty);

        if (includeQuestId) { rowHtml.push(questId); }

        // We now have the `row` array which contains Wikia code for
        // this quest, and the `rowHtml` array which contain HTML code.
        // We save the `row` array into one or more collections of
        // quests, depending on the parameters of this quest.
        // For the HTML table, there is only one collection.

        if (releaseDate === thisMonth) {
            latestQuestUpdatesNeeded += "<strong>" + questName + "</strong> was released this month. Update the tables for: all quests";
        }

        if (quest.previous || dropsScroll || questId === 'evilsanta' || questId === 'dilatoryDistress1') {
            tableRows.questLines.push( convertRow('wikia', row) );
            if (releaseDate === thisMonth) { latestQuestUpdatesNeeded += ", quest lines"; }
        }

        tableRowsHtml.push(rowHtml);
        tableRows.all.push( convertRow('wikia', row) );

        if (rating === '1. easy') {
            tableRows.easy.push( convertRow('wikia', row) );
            if (releaseDate === thisMonth) { latestQuestUpdatesNeeded += ", easy quests"; }
        }
        else if (rating === '2. medium') {
            tableRows.medium.push( convertRow('wikia', row) );
            if (releaseDate === thisMonth) { latestQuestUpdatesNeeded += ", medium quests"; }
        }
        else if (rating === '3. hard') {
            tableRows.hard.push( convertRow('wikia', row) );
            if (releaseDate === thisMonth) { latestQuestUpdatesNeeded += ", hard quests"; }
        }
        if (releaseDate === thisMonth) { latestQuestUpdatesNeeded += ".<br />"; }
    }

    var questTableHeader = '' +
'\n{| class="filterable sortable" border="1" cellpadding="2" cellspacing="0" style="width: 100%; text-align: center; background: #F2F2F2; border:5px solid #F2F2F2;"' +
'\n|- style="background: #284C6D; color: #FFFFFF; white-space: nowrap;"' +
    convertRow('wikia', headers, 'th');

    var questTableFooter = '' +
'\n|- class="sortbottom"' +
'\n| colspan="10" style="height: 0px; border-bottom: 3px solid #284C6D;"|' +
'\n|}\n';


    // create HTML table showing production data and development data:
    var columns = [];
    for (var i in headersHtml) {
        columns.push({'title': headersHtml[i]});
    }
    $(document).ready(function() {
        $('#theTable').DataTable( {
            'data': tableRowsHtml,
            'columns': columns,
            'bPaginate': false,
            'aaSorting': [], // no default sorting
        } );
    } );

    var htmlEnd = '';
    if (releaseDateNeeded) {
        htmlEnd  += '<p>NEED RELEASE DATE:<br />' + releaseDateNeeded + '</p>';
    }
    if (warnings) htmlEnd += '<p>WARNING:<br />' + warnings + '</p>';
    if (false) {
        htmlEnd += "<p>The material below here is Habitica's JSON data that" +
                " was used to make the wikia code above. You can ignore it" +
                " unless you are interested in it. You do not need to" +
                " copy it to the wiki.</p>" +
                "<pre>" + JSON.stringify(allQuests, null, 4) + "</pre>";
    }
    if (devData) {
        htmlEnd += '<pre>' + devData + '</pre>';
    }


    //////////////////////////////////////////////////////////////////////
    ////   Display the HTML    ///////////////////////////////////////////
    //////////////////////////////////////////////////////////////////////

    // XXX use wikiaBaseUrl in text below
    var htmlStart = '';
    ////// var htmlStart = '<p>This page outputs the wikia code for creating tables'
        ////// + ' on the <a href="http://habitica.wikia.com/">Habitica wiki</a>.'
        ////// + ' One table is for the [XXX finish this ... quest table pages ] '
        // + ' <a href="http://habitica.wikia.com/wiki/Equipment_Table">'
        // + 'Equipment Table</a> page, and the other is for the'
        // + ' <a href="http://habitica.wikia.com/wiki/Enchanted_Armoire">'
        // + 'Enchanted Armoire</a> page.</p>'
        // + '<p>Copy everything inside each textarea below and paste it '
        // + 'into the appropriate template pages: <a href="'
        // + 'http://habitica.wikia.com/wiki/Template:Equipment_Table_Code'
        // + '">Template:Equipment_Table_Code</a> and <a href="'
        // + 'http://habitica.wikia.com/wiki/Template:Enchanted_Armoire_Table_Code'
        // + '">Template:Enchanted_Armoire_Code</a>.'
        ////// + '</p>';

    $('#loading .good').hide();
    $('#output').html(htmlStart +
                    '<p>' + latestQuestUpdatesNeeded + '</p>' +
                    '<h2>Notes:</h2>' +
                    '<ul>' +
                    '<li>This is a close-to-final draft of information produced automatically for one or more wiki quest table pages.</li>' +
                    '<li>Tell Alys if you want to propose changes.</li>' +

                    '<li>The <strong>length</strong>, <strong>difficulty</strong>, and <strong>rating</strong> columns do not appear on the wiki but are included in the table below to help us categorise the quests into pages.</li>' +
                    '<li>The <strong>release date</strong> column does not appear on the wiki. It is used here only to help us work out which pages need to be updated when a new quest is released, and so exact release dates for most of the quests are not included.</li>' +
                    ((includeQuestId) ?
                        '<li>The <strong>quest ID</strong> column will not appear on the wiki. It is purely for Alys\'s benefit when setting up the data in the script.</li>' : '') +

                    '<li>Quest scroll images will always look broken in the HTML table here, but will work on the wiki.</li>' +
                    '<li>Sorting won\'t always work correctly in the HTML table here, but will work on the wiki.</li>' +

                    '<li>Any information pulled straight from Habitica should be correct. Any information that Alys had to write code to calculate might be wrong. Any bugs can be easily fixed.</li>' +

                    '</ul>' +

                    '<h2>All Quests</h2>' +
                    '<p>This textarea contains code to produce a Wikia table showing all quests. It is not currently used on the wiki.</p>' +
                    '<textarea rows="5" cols="40" wrap="off">' +
                    questTableHeader +
                    tableRows.all.join("") +
                    questTableFooter +
                    '</textarea>' +

                    '<h2>Quest Lines</h2>' +
                    '<p>This textarea contains code to produce a Wikia table showing only quests that are in quest lines. Paste this code into the <a href="http://habitica.wikia.com/wiki/Template:Quest_Table_Quest_Lines">Quest Table Quest Lines</a> template.</p>' +
                    '<textarea rows="5" cols="40" wrap="off">' +
                    questTableHeader +
                    tableRows.questLines.join("") +
                    questTableFooter +
                    '</textarea>' +

                    '<h2>Easy Quests</h2>' +
                    '<p>This textarea contains code to produce a Wikia table showing only easy quests. Paste this code into the <a href="http://habitica.wikia.com/wiki/Template:Quest_Table_Easy">Quest Table Easy</a> template.</p>' +
                    '<textarea rows="5" cols="40" wrap="off">' +
                    questTableHeader +
                    tableRows.easy.join("") +
                    questTableFooter +
                    '</textarea>' +

                    '<h2>Medium Quests</h2>' +
                    '<p>This textarea contains code to produce a Wikia table showing only medium quests. Paste this code into the <a href="http://habitica.wikia.com/wiki/Template:Quest_Table_Medium">Quest Table Medium</a> template.</p>' +
                    '<textarea rows="5" cols="40" wrap="off">' +
                    questTableHeader +
                    tableRows.medium.join("") +
                    questTableFooter +
                    '</textarea>' +

                    '<h2>Hard Quests</h2>' +
                    '<p>This textarea contains code to produce a Wikia table showing only hard quests. Paste this code into the <a href="http://habitica.wikia.com/wiki/Template:Quest_Table_Hard">Quest Table Hard</a> template.</p>' +
                    '<textarea rows="5" cols="40" wrap="off">' +
                    questTableHeader +
                    tableRows.hard.join("") +
                    questTableFooter +
                    '</textarea>' +

                    '<p>This is an HTML version of the table that shows all quests (but with some differences to the tables you\'ll find on the wiki):</p>' +
                    htmlEnd);
}


function convertRow(format, rowArray, cellType) {
    // format is 'html' or 'wikia'
    var html = (format === 'html') ? true : false;
    cellType = cellType || 'td'; // 'th' can be specified manually
    if (!html) {
        cellType = (cellType === 'td') ? '|' : '!'; // Wikia versions of td and th
    }

    var row = (html) ? '<tr>' : ((cellType === '|') ? '\n|-' : '');
    for (var i in rowArray) {
        var valueObj = rowArray[i];
        var value  = '';
        var config = '';
        if (Object.prototype.toString.call(valueObj) === '[object Array]') {
            value  = valueObj[0];
            config = valueObj[1] + ' | ';
        }
        else {
            value = valueObj;
        }

        row += (html) ?
            '<'  + cellType + '>' :
            '\n' + cellType;
        row += config + value;
        row += (html) ?
            '</' + cellType + '>' :
            '';
    }
    row += (html) ? '</tr>\n' : '';
    return row;
}


function make_url(text, url) {
    if (!url) {
        url = text.replace(/ /g, '_');
    }
    if (url.indexOf('://') === -1) {
        url = wikiaBaseUrl + url;
    }
    return '[' + url + ' ' + text + ']';
    // return [ '<a href="' + url + '">' + text + '</a>',
             // '[[' + url + '|' + text + ']]'           ];
    // return (html) ? '<a href="' + url + '">' + text + '</a>' :
                    // '[[' + url + '|' + text + ']]';
}


function make_image(image, hoverText) {
    if (!image) {
        return '';
    }
    if (image === 'n/a') {
        return image;
    }
    hoverText = hoverText || '';
    return '[[File:' + image + '|' + hoverText + ']]';
    // return [ '<img src="null" />',
             // '[[File:' + image + ']]' ];
    // return (html) ? '<img src="null" />' :
                    // '[[File:' + image + ']]';
}


});
</script>

<style>
/*********************************************************************
****   Page-wide   ***************************************************
*********************************************************************/
body {
    font-family: Helvetica, Arial, sans-serif;
    font-size: 14px;
    background-color: rgb(173, 208, 215);
}
#innerBody {
    margin: 20px;
    padding: 5px 20px 30px 20px;
    background-color: rgb(242, 242, 230);
}
#loading {
    margin-right: 30px;
    margin-left: 30px;
    color: orange;
    font-size: 1.5em;
    font-weight: bold;
}
#loading ul {
    font-size: 0.8em;
}
#loading ul a {
    color: orange;
}


hr {
    width: 95%;
}
hr.padded {
    margin-top:    1em;
    margin-bottom: 2em;
}

.show {
    display: block;
}
.hide {
    display: none;
}
.clear {
    clear: both;
}

.subheading {
    font-weight: bold;
}
.highlight {
    font-weight: bold;
}
.lowlight { /* like highlight but less so */
    font-style: italic;
}
.explanation {
    font-style: italic;
}
abbr {
    border-bottom: 1px dashed black;
}
img.emoji {
    margin-bottom: -0.25em;
}
.forCopyPaste {
    /* used to add blank lines that we want when copying text to clipboard,
       but we don't want to see extra whitespace on the screen */
    margin-top: -1em;
}
ul.padded > li {
    padding: 3px 0;
}

.gearList .item .stats {
    font-variant: small-caps;
}
.gearList .item .key {
    display: none;
}


.coloured {
    display: inline-block;
    width: 5.5em;
    height: 3em;
    padding-top: .7em;
}
.colourBrightBlue { background-color: rgb(209,226,248); }
.colourBlueGrey   { background-color: rgb(216,230,232); }
.colourGreen      { background-color: rgb(222,237,219); }
.colourYellow     { background-color: rgb(255,244,216); }
.colourOrange     { background-color: rgb(254,234,216); }
.colourRed        { background-color: rgb(250,214,214); }
.colourDarkRed    { background-color: rgb(240,197,190); }

.neutral {
    background-color: #fffbd0; /* yellow */
}
.danger {
    background-color: #ffcccc; /* red */
}
.safe {
    background-color: #ccffcc; /* green */
}


/*********************************************************************
****   Header   ******************************************************
*********************************************************************/
h1 {
    float: left;
}
h1>a:first-child { /* "Habitica" link in header */
    color: black;
    text-decoration: none;
}
h1>a:first-child:hover { /* "Habitica" link in header */
    text-decoration: underline;
}
h1 span {
    font-size: 0.5em;
}


/*********************************************************************
****   Header   ******************************************************
*********************************************************************/
table {
    width: 100%;
    border-collapse: collapse;
}
table, th, td {
   border: 1px solid black;
}
th em {
    font-weight: normal;
}


</style>
</head>
<body><div id="innerBody">

<h1><a href="https://habitica.wikia.com/">Habitica Wiki</a> Quest Table Creator
    <span>(last updated 21 January 2016)</span></h1><!-- VERSION -->
<hr class="clear" />

<div id="loading">
    <div class="good hide">
        <p>Please wait. Fetching data from
        <span id="serverName">Habitica</span>...</p>
    </div>
    <div class="bad hide">
        <p>There was an error obtaining the data.</p>
        <ul class="padded">
            <li>Please reload the page (but perhaps wait half an hour first in case Habitica is under heavy load).</li>
            <li>If you're using Internet Explorer, try another browser. <a href="https://www.google.com/intl/en/chrome/browser/">Chrome</a> or <a href="https://www.mozilla.org/en-US/firefox/new/">Firefox</a> will be more reliable.</li>
            <li>If neither of those help, <a href="mailto:lady_alys@oldgods.net">contact me</a>!</li>
        </ul>
    </div>
</div>

<div id="output">
</div>


<br />
<table id="theTable"></table>

<!--
== Table of All Quests in Quest Lines ==
{{:Template:Quest_Table_Quest_Lines}}

<noinclude>
Do not edit this table by hand. Instead, use the "Quest Lines" section in the [https://oldgods.net/habitrpg/quest_table_creator.html Quest Table Creator], which will read the latest "content" data from Habitica and create all the required wikia code. Delete everything below this "noinclude" tag and replace it with that code.
[[Category:Template Tables| ]][[Category:Habitica Templates]]
</noinclude>
-->

</div><!-- end of div id="innerBody" -->
</body>
</html>
