<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>HabitRPG Unofficial User Data Display</title>

<!--

This code is licenced under the same terms as HabitRPG:
    https://raw2.github.com/HabitRPG/habitrpg/develop/LICENSE

https://github.com/Alys/tools-for-habitrpg/blob/master/habitrpg_user_data_display.html
AND required JavaScript libraries:
https://github.com/Alys/tools-for-habitrpg/blob/master/js-for-habitrpg_user_data_display.tar.gz

https://oldgods.net/habitrpg/habitrpg_user_data_display.html
    or http://is.gd/hrpguserdata

Contributors:
    Alys (Alice Harris), lady_alys@oldgods.net
    thepeopleseason (James Hsiao)



TO ADD A NEW SECTION TO THIS PAGE:
Search through this code to find all the comments that start
with "TO ADD NEW SECTION" and follow the (brief) instructions
you'll find there.


-->


<!--
/////
/////
///// IMPORTANT NOTE TO PROGRAMMERS EDITING THIS PAGE:
/////
///// Do not add ANY features to this page which can modify a user's
///// account. This page is a read-only view of their current data.
/////
/////
-->


    <meta name="description" content="HabitRPG Unofficial User Data Display" />
    <meta name="author" content="Alys (Alice Harris) lady_alys@oldgods.net" />


    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <link href="js/DataTables/media/css/jquery.dataTables.css" rel="stylesheet" type="text/css" />
    <script src="js/DataTables/media/js/jquery.dataTables.js"></script>
    <link href="js/DataTables/extras/ColumnFilterWidgets/media/css/ColumnFilterWidgets.css" rel="stylesheet" type="text/css" />
    <script src="js/DataTables/extras/ColumnFilterWidgets/media/js/ColumnFilterWidgets.js"></script>
    <script src="js/emoji-images/emoji-images.js"></script>



<script type="text/javascript">
$(function() { // wraps around all our code to not pollute global namespace

function d(msg) { console.log(msg) } /* laziness FTW! */

//////////////////////////////////////////////////////////////////////
////   Global Variables                              /////////////////
//////////////////////////////////////////////////////////////////////
var content;    // holds site-wide content (gear stats, quests, etc)
var user;       // holds user's data
var localeGear; // holds language-specific, human-friendly names for gear items


//////////////////////////////////////////////////////////////////////
////   Global Connection Variables      //////////////////////////////
//////////////////////////////////////////////////////////////////////
var serverName        = 'HabitRPG'; // used in "loading" message
var serverUrl         = 'https://habitrpg.com:443/api/v2';
var serverPathContent = '/content';
var serverPathUser    = '/user';
var userId            = '';
var apiToken          = '';
var localeServerUrl   = 'https://oldgods.net/habitrpg';
// XXX FIXME!! When running this script locally, localeServerUrl causes this:
//     XMLHttpRequest cannot load https://oldgods.net/habitrpg/locales/en/gear.json. No 'Access-Control-Allow-Origin' header is present on the requested resource. Origin 'http://localhost' is therefore not allowed access. 
// A workaround is to copy locales/en/gear.json from the
// HabitRPG/habitrpg-shared repository and put it on localhost:
// localeServerUrl   = 'http://localhost/HabitRPG-locale-files';


/* TST - FOR TESTING:
localeServerUrl   = 'http://localhost/HabitRPG-locale-files';
serverName        = 'localhost';
serverUrl         = 'http://localhost';
serverPathContent = '/cgi-bin/hrpg_content.pl';
serverPathUser    = '/cgi-bin/hrpg_user.pl';
apiToken          = 'null';
userId            = 'test';
userId            = 'work';
userId            = 'home';
$('#userApiDetailsForm #userId').val(userId);
$('#userApiDetailsForm #apiToken').val(apiToken);
// d("tstfetchprocess: a: testdata submission");
fetchData();
*/

var sectionOpen = ''; // holds the ID attribute of a section of the page;
                      // persists through re-fetch of data so we can
                      // reopen that section when the new data arrives
var hideDropsInDashboard = true; // changes to false as soon as the user
                                 // looks at the drops section, then remains
                                 // false through all future re-fetches
var tellMe = '<a href="mailto:lady_alys@oldgods.net">tell me</a>';



//////////////////////////////////////////////////////////////////////
////   Allow Show/Hide Toggling to work    ///////////////////////////
//////////////////////////////////////////////////////////////////////
enableShowHideToggling(); // needed here to enable Version Changes link
var openRelatedSections = function(){} // redefined later when user data exists
function enableShowHideToggling() {
    // $('.showHideToggle').click(function(event)
    $('body').on('click', '.showHideToggle', function(event){
        var target = $(this).data("target");
        var wantToShow = (! $('#' + target).is(':visible')
                       || $(this).data("forceopen"));
            // wantToShow is false if the target is already open
            // (i.e., the user wants to close it)
            // unless the toggle's attributes force it to always be
            // opened (e.g., a link from the dashboard)
        var linktext = $(this).data("linktext") || false;
        if ($(this).data("closemainsections")) {
            $('#MAIN > *').hide();
        }
        if (wantToShow) {
            sectionOpen = target;
            $('#' + target).show();
            if (linktext) {
                $(this).text('hide ' + linktext);
            }
            openRelatedSections();
        }
        else {
            $('#' + target).hide();
            if (linktext) {
                $(this).text('show ' + linktext);
            }
            if ($(this).data("scrolltotop")) {
                window.scrollTo(0, 0);
            }
        }
        var toggleTarget = $(this).data("resettoggletext") || false;
        if (toggleTarget) {
            $('#' + toggleTarget).text('show '
                        + $('#' + toggleTarget).data("linktext"));
        }
    });
    $('body').on('click', '.mainSectionClose', function(event){
        $('#MAIN > *').hide();
        window.scrollTo(0, 0);
    });
}


//////////////////////////////////////////////////////////////////////
////   Login events      /////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////
$('#userApiDetailsForm').submit(function(event){
    /* The user manually submitted the API connection form. */
    // d("tstfetchprocess: b: manual submission");
    userId   = $('#userId').val();
    apiToken = $('#apiToken').val();
    fetchData();
});


//////////////////////////////////////////////////////////////////////
////   Login and Data Fetch Functions   //////////////////////////////
//////////////////////////////////////////////////////////////////////
function fetchData() {
    // d("tstfetchprocess: loading up to fetchData");
    if (userId == '3e595299-3d8a-4a10-bfe0-88f555e4aa0c' || // AliceHarris
        userId == 'e7b5d1e2-3b6e-4192-b867-8bafdb03eeec'    // Ryan
    ) {
        $('#specialMessage').show();
    }
    else {
        $('#specialMessage').hide();
    }
    $('#loading #serverName').text(serverName);
    $('#loading .good').show();
    $('#loading .bad' ).hide();

    var ajaxRunningCount = 3; // drops to 0 when all calls have succeeded

    // fetch the user's own content (tasks, gear owned, etc):
    $.ajax({
        url: serverUrl + serverPathUser,
        type: 'GET',
        dataType: 'json',
        cache: false,
        beforeSend: function(xhr){
                xhr.setRequestHeader('x-api-user', userId);
                xhr.setRequestHeader('x-api-key',  apiToken);
            },
        success: fetchUserSuccess,
        error: fetchFailure
    });

    // fetch the site-wide content (gear names and stats, etc):
    $.ajax({
        url: serverUrl + serverPathContent,
        type: 'GET',
        dataType: 'json',
        cache: true,
        success: fetchContentSuccess,
        error: fetchFailure
    });

    // fetch the equipment/gear language file:
    var file = '/locales/en/gear.json';
    $.ajax({
        url: localeServerUrl + file,
        type: 'GET',
        dataType: 'json',
        cache: true,
        success: fetchLocaleGearSuccess,
        error: fetchFailure
    });

    function fetchFailure() {
        d("tstfetchprocess: loading failed");
        $('#loading .good').hide();
        $('#loading .bad' ).show();
        $('#documentationAndForm').show(); // in case user has done a re-fetch
        $('#documentationAndFormClose').hide();
        d("tstfetchprocess: stop here!");
    }
    function fetchContentSuccess(data) {
        // d("tstfetchprocess: loading up to saveContentAndFetchUserData");
        content = data;
        ajaxRunningCount--;
        if (ajaxRunningCount === 0) { // all ajax calls have finished
            parseData();
        }
    }
    function fetchUserSuccess(data) {
        // d("tstfetchprocess: loading done - up to displayData");
        user = data;
        ajaxRunningCount--;
        if (ajaxRunningCount === 0) { // all ajax calls have finished
            parseData();
        }
    }
    function fetchLocaleGearSuccess(data) {
        localeGear = data;
        ajaxRunningCount--;
        if (ajaxRunningCount === 0) { // all ajax calls have finished
            parseData();
        }
    }
}
function parseData() {
    // variables for storing the content:
    var MAIN = {}; // each element defines the HTML for one section on the page
    var TOC  = {}; // each element defines one Table of Contents entry
    var DASHBOARD = {}; // each element defines the HTML for one dashboard tile

    // extract some commonly-used data:
    var sleeping = user.preferences.sleep; // true if resting in the inn
    var userKlass = user.stats.class;
    var userKlassPretty = (userKlass == 'wizard') ? 'Mage'
                        : upperCaseFirst(userKlass);
    var health = getCurrentHealth(); // also sets dashboard tile
    var quest;
    if (user.party.quest.key) {
        quest = $.extend({}, user.party.quest);
        quest.content = $.extend({}, content.quests[ user.party.quest.key ] );
    }

    // put the user's equipped battle gear into an object, with all
    // details about each piece:
    var equippedKeys = {};
    for (var i in user.items.gear.equipped) {
        var key = user.items.gear.equipped[i];
        equippedKeys[key] = content.gear.flat[key];
    }

    var computedStats = computeStats(); // computed CON, INT, etc
    var userIsOnCollectionQuest = false;

    userDataInHeader();


    // create the content, section by section:
    //
    // TO ADD NEW SECTION: add a function here, OR add it within one of the
    // functions that is already here if appropriate for correct scoping:
    collateAndDisplayTaskData();
    dropCountAndCap();
    questProgress();
    unallocatedPoints();
    analyseEquipment(); // missing gear, current gear, recommended gear



    //////////////////////////////////////////////////////////////////////
    ////   Display the HTML that the functions have created   ////////////
    //////////////////////////////////////////////////////////////////////
    // d("tstfetchprocess: whoopsies");
    $('#loading .good').hide();
    $('#documentationAndFormClose').show();
    $('#documentationAndForm').hide();
    formatAndDisplayDASHBOARD();
    formatAndDisplayTOC();
    formatAndDisplayMAIN();

    // everything below here is functions used within this function


function formatAndDisplayDASHBOARD() {
    // TO ADD NEW SECTION: To create a dashboard tile (which is optional),
    // add the unique identifier for the new section to this array (the array
    // elements are in the order that the dashboard tiles appear on the page):
    var keys = ['currentHealth', 'dailiesIncomplete', 'damageToUser',
                'damageToParty', 'questProgress', 'todosDated', 'dropsToday',
                'unallocatedPoints', 'sleeping'];
    var html = '<ul>';
    for (var i=0,ic=keys.length; i<ic; i++) {
        var data = DASHBOARD[keys[i]];
        if (! data) {
            continue;
        }
        var classes = (data.hidden) ? 'hide' : '';
        html += '<li ';
        if (data.id) {
            // id is needed only if other code will change tile background
            html += 'id="' + data.id + '" ';
        }
        html += 'title="' + data.hoverText + '" ';
        if (data.target) {
            html += 'data-target="' + data.target +
                    '" data-closemainsections="true" data-forceopen="true" ' +
                    'class="showHideToggle ' + classes + '"';
        }
        html += '><div class="' +
                data.status     + '"><div class="value">' +
                data.value      + '</div><div class="label">' +
                data.label      + '</div></div></li>';
    }


    html += '</ul><div class="clear"></div>';
    $('#DASHBOARD').html(html);
}


function formatAndDisplayTOC() {
    // TO ADD NEW SECTION: To create a Table of Content entry (required),
    // add the unique identifier for the new section to this array (the array
    // elements are in the order that the TOC links appear on the page):
    var keys = [
            'HEADING Tasks',
                'taskOverview', 'taskStatistics', 'untaggedTasks',
                'habitHistory', 'dailiesIncomplete', 'todosDated',
            'HEADING Drops, Quests, Damage', 'dropsToday',
                'questProgress', 'damageDailies', 'statsAndStreaks',
            'HEADING Other',
                'unallocatedPoints', 'missingEquipment',
                'currentGear', 'equipmentRecommendations', 'skillsAndBuffs'];
    var html = '';
    for (var i=0,ic=keys.length; i<ic; i++) {
        if (keys[i].match(/^HEADING/)) { // new section in Table of Contents
            var title = keys[i].replace(/^HEADING/, '');
            if (html) {
                html += '</ul></li>'; // close the previous section
            }
            html += '<li>' + title + ':<ul>';
        }
        else {
            var data = TOC[keys[i]];
            if (! data) {
                continue;
            }
            html += '<li class="showHideToggle" data-target="' +
                    data['target'] + '" data-closemainsections="true">' +
                    data['title']  + '</li>';
        }
    }
    html += '</ul></li></ul>'; // close the final section, and the parent ul
    $('#TOC').html('<ul id="tableOfContents">' + html +
                   '</ul><div class="clear"></div><hr class="padded" />');
}


function formatAndDisplayMAIN() {
    // TO ADD NEW SECTION: To make your new section appear on the page,
    // add the unique identifier for the new section to this array (the array
    // elements are in the order that the sections would appear on the page
    // if they were all visible at once):
    var keys = ['taskOverview', 'taskStatistics', 'untaggedTasks',
                'habitHistory', 'dropsToday', 'questProgress',
                'damageDailies', 'dailiesIncomplete', 'todosDated',
                'statsAndStreaks', 'unallocatedPoints',
                'missingEquipment', 'currentGear', 'equipmentRecommendations',
                'skillsAndBuffs'];
    var html = '';
    var functions = []; // functions to run after HTML code has been loaded
    for (var i=0,ic=keys.length; i<ic; i++) {
        var data = MAIN[keys[i]];
        if (! data) {
            continue;
        }
        html += '<div id="' +
                data.id     + '"><h2>' +
                data.title  + '</h2>' +
                data.html   +
                ((data.longContent) ? '<div class="mainSectionClose closer">' +
                                      'close / back to top</div>' : '') +
                '</div>';
        if (data['function']) {
            functions.push(data['function']);
        }
    }
    $('#MAIN').html(html);
    // execute any functions that need to be run AFTER the bulk of the
    // HTML has been created:
    $.each(functions, function(index,fn){
        fn();
    });
    if (sectionOpen && sectionOpen != 'documentationAndForm'
                    && sectionOpen != 'versionChanges'
    ) {
        // reopen the section that the user had open before re-fetching
        // data (except for sections that don't display the user's own data):
        $('#' + sectionOpen).show();
        openRelatedSections();
    }
}


openRelatedSections = function() {
    if ($('#damageDailiesSection').is(':visible')) {
        $('#dailiesIncompleteSection').show();
    }
    if ($('#dropsTodaySection').is(':visible')) {
        hideDropsInDashboard = false;
        $('#dropsTodayDashboard').show();
        // NOTE: We unhide the number of drops in the dashboard
        // only after the user has opened the main drops section,
        // because some users might prefer to not know (less
        // motivation if they know they've got all of today's drops).
        // BUT we do not reset the dashboard drops show/hide status
        // on re-fetch, because if the user wanted to see drops once,
        // they'll presumably want it again.
        if (userIsOnCollectionQuest) {
            // The user is on a collection quest and has viewed the
            // Drops Received Today section, so also show them the
            // Quest Progress section (collection quests have drops):
            $('#questProgressSection').show();
        }
    }
}


function pluralise(word, number) {
    var lcWord = word.toLowerCase();
    var needUpperCase = (lcWord == word) ? false : true;
    if (number != 1) {
        var pluralWords = {
            'has':   'have',
            'it':    'them',
            'this':  'these',
            'is':    'are',
            'daily': 'dailies',
        };
        if   (pluralWords[lcWord]) { word = pluralWords[lcWord]; }
        else                       { word += 's';    }
    }
    if (needUpperCase) { // must improve this if ever need ALL upper case
        word = upperCaseFirst(word);
    }
    return word;
}


function upperCaseFirst(word) {
    return word.charAt(0).toUpperCase() + word.slice(1);
}


function userDataInHeader() {
    $('#headerExtras').html('<div id="userNameDisplay">' +
            user.profile.name +
            '</div>' +
            '<div id="emailDisplay" class="hide">' +
            user.auth.local.email +
            '</div>' +
            '<div id="explanationAndClearLinks">' +
            '<input id="refetch" type="submit" value="Re-Fetch Data" />' +
            '<span class="showHideToggle" data-target="emailDisplay" data-linktext="email address" title="view the email address that you used to sign up to HabitRPG">show email address</span>' +
            '<span id="documentationAndFormToggle" class="showHideToggle" data-target="documentationAndForm" data-linktext="documentation" data-closemainsections="true">show documentation</span>' +
            '</div>'
    );
    $('#refetch').click(function(event){
        /* The user clicked on the Re-Fetch My Data button. */
        // d("tstfetchprocess: c: refetch submission");
        fetchData();
    });
}


function getCurrentHealth() {
    var health = Math.round(user.stats.hp * 10) / 10;
    // If the user's health is so low that it rounds to 0, then show
    // them a more-precise (hopefully non-zero) number, because 0
    // makes them wonder why they aren't dead:
    if (health == 0) {
        health = Math.round(user.stats.hp * 1000) / 1000;
        if (health == 0) {
            health = Math.round(user.stats.hp * 100000) / 100000;
        }
    }
    DASHBOARD.currentHealth = {'id': 'currentHealthDashboard',
        'label': 'Current Health', 'hoverText': 'your health',
        'value': health, 'status': 'neutral'};
    return health;
}


function collateAndDisplayTaskData() {
    // Set up data structures for storing task information:
    var taskOrder = 0; // default order of tasks in HabitRPG
    var allTasksArray = []; // for Task Overview table
    var untaggedTasks = {'habits':[], 'dailies':[], 'todos':[], 'rewards':[]};
    var template = {'total':0, 'con':0, 'int':0, 'per':0, 'str':0};
    var countTasks = {
        'habits':          $.extend(true, {}, template),
        'dailies':         $.extend(true, {}, template),
        'todosIncomplete': $.extend(true, {}, template),
        'todosComplete':   $.extend(true, {}, template),
        'todosAll':        $.extend(true, {}, template),
        'statsTotals':     $.extend(true, {}, template),
        'rewards':         {'total': 0}
    };
    var exampleTaskType  = '';    // Used to develop...
    var exampleAttribute = '';    // ... a useful customised example...
    var exampleFound     = false; // ... for the Task Statistics section.


    // Define some static stuff:
    var entityMap = {   "&": "&amp;",
                        "<": "&lt;",
                        ">": "&gt;",
                        '"': '&quot;',
                        "'": '&#39;',
                        "/": '&#x2F;'
                    };
    var colours = { 1: {'order':1, 'name':'Bright Blue',
                        'label':       '1) Bright Blue',
                        'nameNoSpace':    'BrightBlue',
                        'id':       'colourBrightBlue'
                       },
                    2: {'order':2, 'name':'Blue Grey',
                        'label':       '2) Blue Grey',
                        'nameNoSpace':    'BlueGrey',
                        'id':       'colourBlueGrey'
                       },
                    3: {'order':3, 'name':'Green',
                        'label':       '3) Green',
                        'nameNoSpace':    'Green',
                        'id':       'colourGreen'
                       },
                    4: {'order':4, 'name':'Yellow',
                        'label':       '4) Yellow',
                        'nameNoSpace':    'Yellow',
                        'id':       'colourYellow'
                       },
                    5: {'order':5, 'name':'Orange',
                        'label':       '5) Orange',
                        'nameNoSpace':    'Orange',
                        'id':       'colourOrange'
                       },
                    6: {'order':6, 'name':'Red',
                        'label':       '6) Red',
                        'nameNoSpace':    'Red',
                        'id':       'colourRed'
                       },
                    7: {'order':7, 'name':'Dark Red',
                        'label':       '8) Dark Red',
                        'nameNoSpace':    'DarkRed',
                        'id':       'colourDarkRed'
                       }
                  };


    // Get an array of all of the user's tags so that when we are
    // examining a task's tags, we can ignore any tags that don't appear
    // in that array (e.g., tags the user has deleted but that weren't
    // removed from the task).
    var knownTags = [];
    $.each(user.tags, function(index, obj){
        knownTags.push(obj.id);
    });


    var habits  = collateHabitsData();  // populates the...
    var dailies = collateDailiesData(); // ... function global variables...
    var todos   = collateTodosData();   // ... defined above...
    var rewards = collateRewardsData(); // ......

    // TO ADD NEW SECTION: if the section is related specifically to tasks,
    // here is probably where you want to put its function.

    // display task data:
    taskOverview();
    taskStatistics();
    untaggedTasksSection();
    habitHistory();
    damageFromDailies();
    dailiesIncomplete();
    todosDated();
    statsAndStreaks();
    skillsAndBuffs();

    function collateHabitsData() {
        var habits = [];
        $.each(user.habits, function(index, obj){
            modifyTaskProperties(obj);
            countTasks['habits']['total']++;
            countTasks['habits'][obj.attribute]++;
            countTasks['statsTotals'][obj.attribute]++;
            countTasks['statsTotals']['total']++;
            if (! exampleFound) {
                exampleTaskType  = 'habits';
                exampleAttribute = obj.attribute;
                if (obj.attribute != 'str') {
                    exampleFound = true; // We won't look for a better example
                    // later; we are happy with this one. We prefer to not use
                    // strength because a less-common attribute will probably
                    // provide a clearer example.
                }
            }
            habits.push(obj);
            allTasksArray.push(createTaskTableCellObj(obj));
            if (! taskIsTagged(obj.tags)) {
                untaggedTasks['habits'].push(obj);
            }
        });
        return habits;
    }


    function collateDailiesData() {
        var dailies = [];
        var valueMin = -47.27; // task values are capped ...
        var valueMax =  21.27; // ... for some purposes
        var today = ["su","m","t","w","th","f","s"][(new Date()).getDay()];
        var conBonus = 1 - (computedStats['con'] / 250);
        if (conBonus < 0.1) { conBonus = 0.1; }
        var stealth = user.stats.buffs.stealth; // user avoids dailies' damage
        $.each(user.dailys, function(index, obj){
            modifyTaskProperties(obj);
            countTasks['dailies']['total']++;
            countTasks['dailies'][obj.attribute]++;
            countTasks['statsTotals'][obj.attribute]++;
            countTasks['statsTotals']['total']++;
            if (! exampleFound) {
                if (obj.attribute != 'str') {
                    exampleTaskType  = 'dailies';
                    exampleAttribute = obj.attribute;
                    exampleFound     = true;
                }
                else {
                    exampleTaskType  = exampleTaskType  || 'dailies';
                    exampleAttribute = exampleAttribute || obj.attribute;
                }
            }

            obj.orderDailies = countTasks['dailies']['total'];
            if (obj.repeat[today]) { // daily is due today
                obj.dueToday = true;
            }
            if (stealth > 0) { // user evades this daily
                stealth--;
                obj.stealthed = true;
                // NB: HabitRPG's code uses up stealth on grey dailies as
                // well as due dailies.
            }

            // calculate damage this daily will do:
            if (sleeping || obj.completed || ! obj.dueToday || obj.stealthed) {
                obj.damageToUser           = 0;
                obj.damageToParty          = 0;
                obj.damageToPartyUnrounded = 0;
            }
            else {
                var currVal = obj.value; // task value
                if (currVal < valueMin) { currVal = valueMin; } // capped
                if (currVal > valueMax) { currVal = valueMax; } // capped
                var nextDelta = Math.abs(Math.pow(0.9747, currVal));
                var checklist = describeChecklist(obj);
                if (checklist.exists) {
                    nextDelta *= (1 - checklist.proportionDone);
                    // NOTE: If you tick off all the items in a Daily
                    // checklist but don't tick off the Daily itself,
                    // you take zero damage (confirmed by testing).
                }
                var delta = nextDelta; // Change this if we ever take
                                       // account of multiple missed days.
                if (quest && quest.content.boss) {
                    obj.damageToPartyUnrounded = delta*quest.content.boss.str;
                    obj.damageToParty
                            = Math.round(obj.damageToPartyUnrounded * 10) / 10;
                }
                else {
                    obj.damageToParty          = 0;
                    obj.damageToPartyUnrounded = 0;
                }
                var hpMod = delta * conBonus * obj.priority * 2;
                // priority is easy (1), medium (1.5), hard (2)
                obj.damageToUser = Math.round(hpMod * 10) / 10;
            }

            dailies.push(obj);
            allTasksArray.push(createTaskTableCellObj(obj));
            if (! taskIsTagged(obj.tags)) {
                untaggedTasks['dailies'].push(obj);
            }
        });
        return dailies;

        function describeChecklist(task) {
            // Takes a task object. Returns an object describing aspects of the
            // task object's checklist (including whether it exists or not).
            if (! task.checklist || task.checklist.length == 0) {
                return {'exists': false};
            }
            var countDone = 0;
            $.each(task.checklist, function(index, obj){
                if (obj.completed == true) { countDone++; };
            });
            return {
                'exists': true,
                'proportionDone': (countDone / task.checklist.length),
                };
        }
    }


    function collateTodosData() {
        var todos = [];
        $.each(user.todos, function(index, obj){
            modifyTaskProperties(obj);
            if (obj.completed == true) {
                countTasks['todosComplete']['total']++;
                countTasks['todosComplete'][obj.attribute]++;
                countTasks['statsTotals'][obj.attribute]++;
                countTasks['statsTotals']['total']++;
                countTasks['todosAll']['total']++;
                countTasks['todosAll'][obj.attribute]++;
                return true; // currently we don't display completed to-dos
            }
            else {
                countTasks['todosIncomplete']['total']++;
                countTasks['todosIncomplete'][obj.attribute]++;
                countTasks['statsTotals'][obj.attribute]++;
                countTasks['statsTotals']['total']++;
                countTasks['todosAll']['total']++;
                countTasks['todosAll'][obj.attribute]++;
                if (! exampleFound) {
                    if (obj.attribute != 'str') {
                        exampleTaskType  = 'todosIncomplete';
                        exampleAttribute = obj.attribute;
                        exampleFound     = true;
                    }
                    else {
                        exampleTaskType  = exampleTaskType  ||'todosIncomplete';
                        exampleAttribute = exampleAttribute || obj.attribute;
                    }
                }
            }
            todos.push(obj);
            allTasksArray.push(createTaskTableCellObj(obj));
            if (! taskIsTagged(obj.tags)) {
                untaggedTasks['todos'].push(obj);
            }
        });
        return todos;
    }


    function collateRewardsData() {
        var rewards = [];
        $.each(user.rewards, function(index, obj){
            modifyTaskProperties(obj);
            countTasks['rewards']['total']++;
            rewards.push(obj);
            if (! taskIsTagged(obj.tags)) {
                untaggedTasks['rewards'].push(obj);
            }
        });
        return rewards;
    }


    function modifyTaskProperties(obj) {
        obj.text = String(obj.text).replace(/\&nbsp;/g, ' ');
        obj.text = obj.text.replace(/[&<>"'\/]/g, function (s) {
                        return entityMap[s];
                    });
        obj.text = emoji(obj.text, 'js/emoji-images/pngs', 25);
        obj.valueRounded = Math.round(obj.value * 100) / 100;
        obj.order = ++taskOrder;
        obj.colour = chooseColour(obj.value);
        obj.valueColourHtml = '<span class="coloured '
                + obj.colour.id + '">'
                + obj.valueRounded + '<br />'
                + obj.colour.nameNoSpace
                + '</span>';

        function chooseColour(value) {
            // from http://habitrpg.wikia.com/wiki/Task_Value :
            // Bright Blue  Greater than 10
            // Blue Grey    Between 5 and 10
            // Green        Between 1 and 5
            // Yellow       Between -1 and 1
            // Orange       Between -10 and -1
            // Red          Between -20 and -10
            // Dark Red     Less than -20
            if      (value >  10){ return colours[1]; }
            else if (value >   5){ return colours[2]; }
            else if (value >   1){ return colours[3]; }
            else if (value >  -1){ return colours[4]; }
            else if (value > -10){ return colours[5]; }
            else if (value > -20){ return colours[6]; }
            else                 { return colours[7]; }
        }
    }


    function taskIsTagged(tagObj) { // returns true if tagged, false otherwise
        tagFound = false; // we have not yet found any valid tags for this task
        $.each(tagObj, function(tagId, value){
            if (value === false) {
                // this tag was once applied to the task, but no longer
                return true; // go to next iteration
            }
            if ($.inArray(tagId, knownTags) >= 0) {
                tagFound = true;
                return false; // break out of the loop
            }
        });
        return tagFound;
    }


    function createTaskTableCellObj(obj) { // XXX_LATER remove; use obj itself
        var date = new Date(obj.dateCreated); // ASSUME 'date' is a real date!
        var formattedDate = myDateConverter(date, 'long');
        var shortDate     = myDateConverter(date, 'short');
        return {'type':      ((obj.type == 'todo') ? 'to-do' : obj.type),
                'attribute': obj.attribute.toUpperCase(),
                'text': {'full':  obj.text,
                         'short': obj.text.replace(/(^.{80}).+/, "$1 ..."),
                        },
                'colour':    obj.colour,
                'value':     obj.valueRounded,
                'magnitude': Math.abs(obj.valueRounded),
                'creation':  {'dateAndTime': formattedDate,
                              'shortDate': shortDate,
                             },
                'order':     obj.order,
                'valueColourHtml': obj.valueColourHtml,
            };
    }


    function myDateConverter(date, style) {
        var y = date.getFullYear();
        var m = date.getMonth() + 1;
        var d = date.getDate();
        var H = date.getHours();
        var M = date.getMinutes();
        var S = date.getSeconds();
        var dateStr = y +
               '-' + (m<=9 ? '0'+m : m) +
               '-' + (d<=9 ? '0'+d : d);
        if (style === 'short') {
            dateStr = dateStr.replace(/^20/, ""); // remove century
        }
        if (style === 'long') {
            dateStr += ' ' + (H<=9 ? '0'+H : H) +
                       ':' + (M<=9 ? '0'+M : M) +
                       ':' + (S<=9 ? '0'+S : S);
        }
        return dateStr;
    };


    function taskOverview() { // Displays all tasks of all kinds.
        // Also shows one random to-do:
        var randomTodo = todos[Math.floor(Math.random() * todos.length)];

        var title   = 'Task Overview';
        var id      = 'taskOverviewSection';
        var orderId =  'taskOverview';
        TOC[orderId]  = {'target': id, 'title':  title};
        MAIN[orderId] = {'id': id, 'title': title, 'longContent': true,
                   'function': createTaskOverviewTable,
                   'html':
'<div id="taskOverviewExplanationToggle" class="showHideToggle" data-target="taskOverviewExplanation" data-linktext="explanation">show explanation</div>' +
'<div id="taskOverviewExplanation" class="hide">' +
'   <p class="lowlight">NOTE: This feature contains advanced JavaScript and layout options which will probably perform differently in different browsers. If you experience problems, ' + tellMe + '.</p><p>The table below shows your tasks (habits, dailies, and to-dos), with their <a href="http://habitrpg.wikia.com/wiki/Advanced_Options">attributes</a> and <a href="http://habitrpg.wikia.com/wiki/Task_Value">colours, values, and magnitudes</a> (value and magnitude are useful for choosing tasks to cast skills on). Completed to-dos are not shown; completed dailies are.</p><ul class="padded"><li><span class="subheading">Sorting:</span> Click on a column heading to sort the table by that column. Then, hold down your shift key and click on other column headings for a multi-column sort. The starting sort order is the order of your tasks in HabitRPG.</li><li><span class="subheading">Filtering:</span> Use the drop-down menus ("type", "attr.", "colour") to filter the list. Select multiple items from one menu to filter for tasks matching <span class="highlight">any</span> of those items (widen the filter). Select items from a different menu to narrow the filter. Click on the blue links that you\'ll see after you\'ve chosen a filter to remove that filter.</li><li><span class="subheading">Searching:</span> Type words in the search box to show only tasks containing all of those words. This is <span class="highlight">not</span> just for task titles; you can search on any field. The words do not have to be consecutive. Examples:<ul><li>Search for "car wash" to find the task "wash the car"</li><li>Search for "balloon habit" to find all habits that contain the word "balloon".</li><li>Search for "14-01-30" (or "2014-01-30" or "01-30") to find tasks created on that day.</li></ul></li><li><span class="subheading">What dark magic is this?</span> <a href="http://datatables.net/">Data Tables</a> (a plug-in for jQuery, which adds advanced interaction controls to any HTML table). <a href="http://legacy.datatables.net/extras/thirdparty/ColumnFilterWidgets/DataTables/extras/ColumnFilterWidgets/">ColumnFilterWidgets</a> (an add-on for DataTables, which creates filtering widgets based on the data in table columns).</li></ul><p>Underneath this table, you will find one randomly-selected item from your to-do list. Re-fetch your data to see a different random to-do.</p>' +
'   <div class="showHideToggle closer" data-target="taskOverviewExplanation" data-resettoggletext="taskOverviewExplanationToggle">hide explanation</div>' +
'</div>' +
'<table></table>' +
'<h3>Random To-Do</h3><p>' +
randomTodo.text + '</p>'
};

        function createTaskOverviewTable() {
            // Use DataTables to build the table (the table tag must be
            // visible first for layout to be correct):
            $('#taskOverviewSection').show();
            $('#taskOverviewSection table').dataTable({
                'aaData': allTasksArray,
                'aoColumns': [
            { 'mData' : 'order', // needed to ensure correct starting sort
              'sTitle': '#',    'bVisible': false,
            },
            { 'mData' : 'type',       'sClass': 'center',
              'sTitle': 'type',       'sWidth': '10%',
            },
            { 'mData' : 'attribute',  'sClass': 'center',
              'sTitle': 'attr.',       'sWidth': '10%',
            },
            { 'mData' : 'colour.label',
              'sTitle': 'colour',     'sClass': 'center', 'bVisible': false,
            },
            { 'sTitle': 'value',  'sClass': 'center',       'sWidth': '10%',
              'mData': function ( source, type, val ) {
                if (type === 'set') {
                  return; // http://datatables.net/ref#mData
                }
                else if (type === 'display') {
                  return source.valueColourHtml;
                }
                else if (type === 'filter') {
                  return source.colour.name;
                }
                // 'sort', 'type' and undefined all just use the integer
                return source.value;
              }
            },
            { 'mData' : 'magnitude', 'sClass': 'center', 'sWidth': '10%',
               'asSorting': ['desc','asc'],
              'sTitle': '<abbr title="magnitude (the value, but with negative'
                        + ' signs removed)">mag.</abbr>',
            },
            { 'sTitle': '<abbr title="creation date">added</abbr>',
              'sClass': 'center',       'sWidth': '10%',
              'asSorting': ['desc','asc'],
              'mData': function ( source, type, val ) {
                if (type === 'set') {
                  return;
                }
                else if (type === 'display') {
                  return '<abbr title="'
                       + source.creation.dateAndTime + '">'
                       + source.creation.shortDate
                       + '</abbr>';
                }
                else if (type === 'filter') {
                  return source.creation.dateAndTime;
                }
                return source.creation.dateAndTime;
              }
            },
            { 'sTitle': 'task',       'sWidth': '*',
              'mData': function ( source, type, val ) {
                if (type === 'set') {
                  return;
                }
                else if (type === 'display') {
                  return source.text.full;
                }
                else if (type === 'filter') {
                  return source.text.full;
                }
                return source.text.full;
                // this routine made a lot more sense when I was
                // experimenting with different text for
                // display, filter, sort
              }
            },
                ],
                // 'scrollY': 300,
                // 'bInfo': false,
                // 'sDom': 'W<"clear"><"top"if>rt<"bottom"iflp><"clear">',
                'sDom': 'W<"clear"><"top"if>rt<"bottom"><"clear">',
                'bAutoWidth': false,
                'bPaginate': false,
                'bDeferRender': true,
                // 'bSortClasses': false,
                "sScrollX": "100%",
                // "sScrollXInner": "200%",
                "bDestroy": true, // allows table to recreate on refetch
                'oColumnFilterWidgets': {
                    'aiExclude': [ 0, 4, 5, 6, 7, 8 ],
                }
            });
            $('#taskOverviewSection').hide();
            return;
        }
    }


    function taskStatistics() {
        var title = 'Task Statistics';
        var html = '<p>This table shows the number of tasks you have ' +
            'for each kind of task (habits, dailies, to-dos) ' +
            'and the number of tasks assigned to each ' +
            '<a href="http://habitrpg.wikia.com/wiki/Character_Attributes">' +
            'attribute</a>.';
        if (exampleTaskType && exampleAttribute) {
            html += ' For example, you have ' +
                    countTasks[exampleTaskType]['total'] + ' ' +
                    ((exampleTaskType == 'todosIncomplete')
                                ? 'incomplete to-dos' : exampleTaskType);
            if (countTasks[exampleTaskType]['total']
                    == countTasks[exampleTaskType][exampleAttribute]) {
                html += ' and all have';
            }
            else {
                html += ' of which ' +
                        countTasks[exampleTaskType][exampleAttribute] +
                        ' ' +
                        pluralise('has',
                            countTasks[exampleTaskType][exampleAttribute]);
            }
            html += ' been assigned to ' +
                    exampleAttribute.toUpperCase() + '.';
        }
        html += ' Note that attributes on tasks are only relevant if you ' +
            'have task-based <a ' +
            'href="http://habitrpg.wikia.com/wiki/Automatic_Allocation">' +
            'auto-allocation</a> turned on.</p><table><tr>' +
            '<th>Attribute</th><th>Habits</th><th>Dailies</th>' +
            '<th>To-Dos - Incomplete</th><th>To-Dos - Complete *</th>' +
            '<th>To-Dos - All</th><th>Total Tasks for each Attribute</th>' +
            '</tr>';
        $.each(['con','int','per','str','total'], function(index, attr){
            html += '<tr' +
                    ((attr == 'total') ? ' class="total"' : '') +
                    '><td>' +
                    ((attr.length==3) ? attr.toUpperCase()
                                      : upperCaseFirst(attr))
                    '</td>';
            $.each(['habits','dailies','todosIncomplete','todosComplete',
                    'todosAll','statsTotals'], function(index, type){
                html += '<td>' + countTasks[type][attr] + '</td>';
            });
            html += '</tr>';
        });
        html += '</table>' +
            '<p class="lowlight"><strong>*</strong> Your completed to-dos ' +
            'are automatically archived after three days to improve ' +
            'HabitRPG\'s speed and so most of them cannot be seen in ' +
            'HabitRPG. However, at least some of them can be exported ' +
            'using the <a href="http://habitrpg.wikia.com/wiki/Data_Export">' +
            '"User Data" export option</a>. This total number of completed ' +
            'to-dos includes those archived ones.</p>' +
            '<p style="margin-top:2em">You have <span class="highlight"> ' +
            countTasks['rewards']['total'] + ' ' +
            pluralise('reward', countTasks['rewards']['total']) +
            '</span>.</p>';

        // Training Points:
        if (user.preferences.automaticAllocation &&
            user.preferences.allocationMode == 'taskbased'
           ) {
            title += ' and Training Points';
            html += '<h3>Training Points</h3>' +
                '<p>When you use task-based <a ' +
                'href="http://habitrpg.wikia.com/wiki/Automatic_Allocation">' +
                'auto-allocation</a>, you gain and lose points of training ' +
                'for the <a ' +
                'href="http://habitrpg.wikia.com/wiki/Character_Attributes">' +
                'attributes</a> you\'ve assigned to your tasks. When you ' +
                'level up, the attribute with the most training gets a ' +
                'point assigned, and all training resets to 0 for the ' +
                'next level. Your current training points are:</p>' +
                '<table>';
            $.each(user.stats.training, function(key, value){
                value = Math.round(value * 10) / 10;
                html += '<tr><td>' +
                        key.toUpperCase() + '</td><td>' +
                        value + '</td></tr>';
            });
            html += '</table>';
        }

        var id      = 'taskStatisticsSection';
        var orderId = 'taskStatistics';
        TOC[orderId]  = {'target': id, 'title':  title};
        MAIN[orderId] = {'id': id, 'title': title, 'html': html};
    }


    function untaggedTasksSection() {
        var html = formatUntaggedTasks('Habits',  untaggedTasks['habits' ]) +
                   formatUntaggedTasks('Dailies', untaggedTasks['dailies']) +
                   formatUntaggedTasks('To-Dos',  untaggedTasks['todos'  ]) +
                   formatUntaggedTasks('Rewards', untaggedTasks['rewards']);
        if (! html) {
            return;
        }
        var id    = 'untaggedTasksSection';
        var title = 'Tasks Untagged';
        var orderId = 'untaggedTasks';
        TOC[orderId] = {'target': id, 'title':  title};
        MAIN[orderId] = {'id': id, 'title': title, 'longContent': true,
            'html': html};
        function formatUntaggedTasks(title, tasks) {
            var html = '';
            $.each(tasks, function(index, obj){
                html += '<li>' + obj.text + '</li>';
            });
            if (html) {
                return '<h3>' + title + '</h3><ul>\n' + html + '</ul>';
            }
            else {
                return '';
            }
        }
    }


    function habitHistory() {
        var html = '<p class="narrowContent">This shows your habits and <strong>some</strong> of the dates and times you clicked on them; there is <a href="https://github.com/HabitRPG/habitrpg/issues/3079">an issue</a> which prevents HabitRPG from showing all of your clicks. <!-- IF THE ISSUE GOES AWAY: ... and the dates and times they were marked <span class="buttonUsed">up</span> (+ button) or <span class="buttonUsed">down</span> (- button). It does not include any archived history data that might have been saved for your account, so it contains only recent data. For up-and-down habits (where both + and - are active), most of the data points are marked with <span class="buttonUsed">up</span> or <span class="buttonUsed">down</span>, but for the oldest data point, it is not possible to tell whether + or - had been hit. --> Habits with no history are highlighted in bold, in case you would like to consider them for greater focus.</p><ul>';
        $.each(habits, function(index, obj){
            html += collateHistoryForOneHabit(obj);
        });
        html += '</ul>';
        var id      = 'habitHistorySection';
        var title   = 'Habit History';
        var orderId = 'habitHistory';
        TOC[orderId]  = {'target': id, 'title':  title};
        MAIN[orderId] = {'id': id, 'title': title, 'longContent': true,
                         'html': html};

        function collateHistoryForOneHabit(obj) {
            //// The commented out code below is only useful if ALL recent
            //// habit clicks are recorded in the user's data.
            //// Currently they are not:
            ////    https://github.com/HabitRPG/habitrpg/issues/3079
            ////    "habit history condenses current day's data"

            //// var canDoDown = obj.down;
            //// var canDoUp   = obj.up;
            //// var canDoBoth = canDoDown && canDoUp;

            // Here we take each history item, convert its date to a
            // standard format (my histories have varying formats,
            // presumably from different apps I've used), and store
            // it in an array; then we sort the array by date:
            var historyItems = [];
            $.each(obj.history, function(index, histObj){
                var value = histObj.value;
                var date = new Date(histObj.date);
                historyItems.push({"date":date, "value":value});
            });
            historyItems.sort(function(a,b) {
                return a.date - b.date;
            });

            //// var previousValue; // used to work out if user hit + or -
            var historyList = [];
            $.each(historyItems, function(index, histObj){
                var value = histObj.value;
                var date  = myDateConverter(histObj.date, 'long');
                //// var buttonUsed = '?up/down?'; // default value
                //// if (canDoBoth) {
                    //// if (previousValue != undefined) {
                        //// buttonUsed = (value > previousValue) ? 'up':'down';
                    //// }
                //// }
                //// else {
                    //// buttonUsed = (canDoUp) ? 'up' : 'down';
                //// }
                value = Math.round(value * 100) / 100;
                historyList.push('<li>'
                        + date
                        //// + ': ' + ' <span class="buttonUsed">'
                        //// + buttonUsed
                        //// + '</span>'
                        + ' <span class="historyValue">(value: '
                        + value + ')</span>'
                        + '</li>');
                //// previousValue = value;
            });
            var habitText = obj.text;
            var noHistoryClass = '';
            if (historyList.length == 0) {
                noHistoryClass = 'noHistory';
                habitText += ' <span>(no history)</span>';
            }
            else {
                historyList.reverse(); // put most recent at top (we couldn't
                       // do this earlier when we sorted the items because the
                       // 'buttonUsed' code needed them in chronological order
                habitText += '<ul class="padded">' +
                           historyList.join('') + '</ul>';
            }
            return '<li class="' + noHistoryClass + '">' + habitText + '</li>';
        }
    }


    function damageFromDailies() {
        var id      = 'damageDailiesSection';
        var title   = 'Damage from Dailies';
        var orderId = 'damageDailies';
        var html = '<p class="lowlight">Be cautious about using this to prevent death! &nbsp; <span id="damageDailiesExplanationToggle" class="showHideToggle" data-target="damageDailiesExplanation" data-linktext="explanation">show explanation</span></p><ul id="damageDailiesExplanation" class="padded hide"><li>These estimates have been accurate during testing but your usage of HabitRPG might involve factors that were not considered, and so this information cannot be guaranteed to be correct.</li><li>If your health is low, it is wise to protect yourself from death even if these estimates indicate that you will not die.</li><li>If you have not logged in to HabitRPG for more than a day, the damage that you (and your fellow quest participants) will take will be <span class="highlight">much greater</span> than shown here.</li><li class="showHideToggle lowlight" data-target="damageDailiesExplanation" data-resettoggletext="damageDailiesExplanationToggle" style="list-style-type: none; padding: 8px 0 20px 0">hide explanation</li></ul>';
        var modifyHealthDashboardTile = false;
        if (sleeping) {
            html += '<p>You are <a href="http://habitrpg.wikia.com/wiki/Tavern">resting in the inn</a> so you will not take any damage from your uncompleted dailies.</p>';
            if (quest && quest.content.boss) {
                html += '<p> However, you are also on a <a href="http://habitrpg.wikia.com/wiki/Boss">boss</a> <a href="http://habitrpg.wikia.com/wiki/Quests">quest</a> so you <span class="highlight">will</span> still take damage from the uncompleted dailies of other quest participants.</p>';
            }
        }
        else {
            var damageToUser  = 0;
            var damageToParty = 0;
            $.each(dailies, function(index, obj){
                damageToUser  += obj.damageToUser; // H'RPG uses rounded value
                damageToParty += obj.damageToPartyUnrounded;
            });
            var damageTotal = Math.ceil((damageToUser + damageToParty)*10)/10;
            damageToUser    = Math.ceil(damageToUser  * 10) / 10;
            damageToParty   = Math.ceil(damageToParty * 10) / 10;
            // We round UP with ceil because we must never let the user
            // think they will take even slightly less damage than they really
            // will. Imagine if they died from an extra 0.1 damage that this
            // page didn't tell them they had!
            if (quest && quest.content.boss) {
                if (damageToUser == 0) {
                    html += '<p>You and your fellow ' +
                        '<a href="http://habitrpg.wikia.com/wiki/Quests">' +
                        'quest</a> participants will take an ' +
                        '<span class="highlight">estimated 0</span> damage ' +
                        'from your own dailies.</p><p>However you ' +
                        '<span class="highlight">will</span> still take ' +
                        'damage from the uncompleted dailies of other quest ' +
                        'participants.</p>';
                }
                else {
                    html += '<p>If you do no more dailies today, you will ' +
                        'take an <span class="highlight">estimated ' +
                        damageToUser +
                        '</span> damage from your dailies directly.</p>' +
                        '<p>In addition, you are on a <a ' +
                        'href="http://habitrpg.wikia.com/wiki/Quests">' +
                        'quest</a>, so the <a ' +
                        'href="http://habitrpg.wikia.com/wiki/Boss">boss</a>' +
                        ' will inflict an <span class="highlight">estimated ' +
                        damageToParty +
                        '</span> damage to you and to your fellow quest ' +
                        'participants because of your uncompleted dailies.' +
                        '</p><p>Thus your total damage due to your own ' +
                        'uncompleted dailies will be ' +
                        '<span class="highlight">approximately ' +
                        damageTotal + '</span>. ' +
                        'Your current health is <span class="highlight">' +
                        health +
                        '</span>.</p>' +
                        '<p>You will also take damage from the uncompleted' +
                        ' dailies of other quest participants.</p>';
                }
            }
            else {
                html += '<p>If you do no more dailies today, you will take ' +
                    'an <span class="highlight">estimated ' +
                    damageToUser +
                    '</span> damage. Your current health is ' +
                    '<span class="highlight">' +
                    health +
                    '</span>.</p>';
            }
            if (damageTotal >= health) {
                // make the Current Health dashboard tile
                // turn red when your health is too low
                modifyHealthDashboardTile = function(){
                    $('#currentHealthDashboard > div')
                            .removeClass('neutral').addClass('danger');};
            }
        }
        TOC[orderId]  = {'target': id, 'title':  title};
        MAIN[orderId] = {'id': id, 'title': title, 'html': html,
                         'function': modifyHealthDashboardTile };

        if (sleeping) {
            DASHBOARD.sleeping = {'label': '',
                'hoverText': 'You are resting in the inn. Go to the ' +
                         'Social page to check out of the inn.',
                'target': id, 'value': 'Zz<sub>zZzz<sub>zz</sub></sub>',
                'status': 'safe'};
        }
        else {
            DASHBOARD.damageToUser = {'label': 'Est. Damage',
                'hoverText': 'health loss you will take overnight from your ' +
                         'uncompleted dailies (click for more information)',
                'target': id, 'value': damageToUser,
                'status': ((damageToUser) ? 'danger' : 'safe')
                };
            if (quest && quest.content.boss) {
                DASHBOARD.damageToParty = {'label': 'Est. Boss Damage',
                    'hoverText': 'health loss you and your party will take ' +
                         'overnight from your quest boss due to your own ' +
                         'uncompleted dailies (click for more information)',
                    'target': id, 'value': damageToParty,
                    'status': ((damageToParty) ? 'danger' : 'safe')
                    };
            }
        }
    }


    function dailiesIncomplete() {
        var id      = 'dailiesIncompleteSection';
        var title   = 'Dailies Incomplete';
        var orderId = 'dailiesIncomplete';

        if (sleeping) {
            return; // can't do dailies while resting in inn
        }
        var dailiesIncomplete     = [];
        var dailiesIncompleteGrey = [];
        for (var i=0,ic=dailies.length; i<ic; i++) {
            var obj = dailies[i];
            if (obj.completed) {
                continue;
            }
            if (obj.dueToday) { // daily is due today
                dailiesIncomplete.push(obj);
            }
            else {
                dailiesIncompleteGrey.push(obj.text);
            }
        }

        if ((dailiesIncomplete.length + dailiesIncompleteGrey.length) == 0) {
            DASHBOARD[orderId] = {'label': title,
                'hoverText': 'you have completed all dailies and grey dailies',
                'value': '0', 'status': 'safe'};
            return;
        }
        var html = '';
        if (dailiesIncomplete.length > 0) {
            html += '<p>The table below shows the dailies that are due ' +
                    'today and have not yet been completed. It tells you ' +
                    'the estimated damage you will take from each daily';
            if (quest && quest.content.boss) {
                html += ' and how much damage each daily will let the <a ' +
                    'href="http://habitrpg.wikia.com/wiki/Quests">quest</a> ' +
                    '<a href="http://habitrpg.wikia.com/wiki/Boss">boss</a> ' +
                    'do to your party members <span class="highlight"> ' +
                    'and you</span>';
            }
            html += '. Click on any column header to sort by that column; ' +
                    'for example; sort by "damage to you" to find the most ' +
                    'damaging dailies to action first if you won\'t have ' +
                    'time to do them all. The damage estimates take into ' +
                    'account damage reduction from partially-completed <a ' +
                    'href="http://habitrpg.wikia.com/wiki/Checklist#Dailies">' +
                    'checklists</a>, so you might find it is better to do ' +
                    'a blue daily instead of a mostly-completed red daily.' +
                    '</p><table></table>';
        }
        else {
            html += '<p>You have completed all of the dailies due today.</p>';
        }
        if (dailiesIncompleteGrey.length > 0) {
            html += '<h3>Grey Dailies</h3><p>' +
                    pluralise('This', dailiesIncompleteGrey.length) +
                    ' <a href="http://habitrpg.wikia.com/wiki/Dailies#' +
                    'Grey_Dailies">grey ' +
                    pluralise('daily', dailiesIncompleteGrey.length) +
                    '</a> ' +
                    pluralise('is', dailiesIncompleteGrey.length) +
                    ' <span class="highlight">not</span> due today but' +
                    ' you can still complete ' +
                    pluralise('it', dailiesIncompleteGrey.length) +
                    ' for extra rewards:</p><ul class="padded"><li>' +
                    dailiesIncompleteGrey.join('</li><li>') +
                    '</li></ul>';
        }
        DASHBOARD[orderId] = {'label': title,
            'hoverText': 'number of dailies you have not yet completed ' +
                         '(click for more information)',
            'target': id,
            'value': dailiesIncomplete.length,
            'status': ((dailiesIncomplete.length > 0) ? 'danger' : 'safe')
            };
        TOC[orderId]  = {'target': id, 'title':  title};
        MAIN[orderId] = {'id': id, 'title': title, 'longContent': true,
                   'function': ((dailiesIncomplete.length > 0) ?
                                createDailiesIncompleteTable : false),
                   'html': html};


        function createDailiesIncompleteTable() {
            // Use DataTables to build the table (the table tag must be
            // visible first for layout to be correct):
            $('#dailiesIncompleteSection').show();
            $('#dailiesIncompleteSection table').dataTable({
                'aaData': dailiesIncomplete,
                'aoColumns': [
            { 'mData' : 'orderDailies',   'sClass': 'center',
              'sTitle': 'order in HabitRPG',
            },
            { 'mData' : 'streak',         'sClass': 'center',
              'sTitle': 'current streak',
            },
            { 'sTitle': 'value', 'sClass': 'center', 'asSorting': ['desc','asc'],
              'mData': function ( source, type, val ) {
                if (type === 'set') {
                  return; // http://datatables.net/ref#mData
                }
                else if (type === 'display') {
                  return source.valueColourHtml;
                }
                else if (type === 'filter') {
                  return source.colour.name;
                }
                // 'sort', 'type' and undefined all just use the integer
                return source.value;
              }
            },
            { 'mData' : 'damageToUser',    'sClass': 'center',
              'sTitle': 'damage to you',   'asSorting': ['desc','asc'],
            },
            { 'mData' : 'damageToParty',   'sClass': 'center',
              'sTitle': 'damage to party', 'asSorting': ['desc','asc'],
              'bVisible': ((quest && quest.content.boss) ? true : false),
            },
            { 'sTitle': 'stealthed',       'sClass': 'center',
              'mData': function ( source, type, val ) {
                  return (source.stealthed) ? 'yes' : 'no';
              },
              'bVisible': user.stats.buffs.stealth,
            },
            { 'mData' : 'text',
              'sTitle': 'task',
            },
                ],
                'sDom': '<"clear"><"top"if>rt<"bottom"><"clear">',
                'bAutoWidth': false,
                'bPaginate': false,
                'bDeferRender': true,
                "sScrollX": "100%",
                "bDestroy": true,
            });
            $('#dailiesIncompleteSection').hide();
            return;
        }
    }


    function todosDated() {
        var id      = 'todosDatedSection';
        var title   = 'To-Dos with Dates';
        var orderId = 'todosDated';

        var today = myDateConverter(new Date(), 'medium');
        var lastWeek = new Date();
        lastWeek.setDate(lastWeek.getDate() - 7);
        lastWeek = myDateConverter(lastWeek, 'medium');

        var items = [];
        var countDue = 0;
        var dangerTodoFound = false;
        for (var i=0,ic=todos.length; i<ic; i++) {
            var obj = todos[i];
            if (! obj.date) {
                continue;
            }
            var challenge = (obj.challenge && obj.challenge.id)
                          ? ' <span class="challenge">(challenge to-do)</span>'
                          : '';
            var date = myDateConverter(new Date(obj.date), 'medium');
            var dateClass = 'notDue';
            if (date <= today) {
                dateClass = 'due';
                countDue++;
                if (! challenge || date > lastWeek) {
                    // An overdue to-do is not dangerous if it is from a
                    // challenge and is more than a week old (because the
                    // user probably doesn't care about it).
                    dangerTodoFound = true;
                }
            }
            items.push('<li class="' + dateClass + '"><span class="date">' +
                       date + '</span> ' +
                       obj.text + challenge + '</li>');
        }
        if (items.length === 0) {
            return;
        }
        var html = '<p class="lowlight"><span class="highlight">WARNING:' +
                   '</span> I\'m not sure if this handles timezones ' +
                   'correctly! To-dos due today might appear with ' +
                   'tomorrow\'s date (and so the dashboard counter might ' +
                   'be wrong). Watch out for that for the first few days ' +
                   'that you use this feature. Please ' +
                   tellMe + ' if you notice problems.</p>';
        html += '<ul class="padded">';
        html += items.sort().join('');
        html += '</ul>';

        if (countDue) {
            DASHBOARD[orderId] = {'label': 'To-Dos Due Today',
                'hoverText': 'number of to-dos due today or overdue ' +
                             '(click for more information)',
                'target': id,
                'value': countDue,
                'status': ((dangerTodoFound) ? 'danger' : 'neutral')};
        }
        TOC[orderId]  = {'target': id, 'title':  title};
        MAIN[orderId] = {'id': id, 'title': title, 'html': html};
    }


    function statsAndStreaks() {
        var id      = 'statsAndStreaksSection';
        var title   = 'Stats and Streaks Backup';
        var orderId = 'statsAndStreaks';
        var html = '<p>This section lists information that you might need ' +
            'if you <a href="http://habitrpg.wikia.com/wiki/' +
            'Death_Mechanics">die</a> due to circumstances out of your ' +
            'control (e.g., if you lose internet access and can\'t tick ' +
            'off your dailies). ' +
            'Your stats (Health, etc) can be restored using "Fix Character ' +
            'Values" in the <a href="http://habitrpg.wikia.com/wiki/' +
            'Settings">Settings</a> page. Your dailies\' streaks can be ' +
            'reset using <a href="http://habitrpg.wikia.com/wiki/Streaks">' +
            'Restore Streak</a> in the Avanced Options for each daily.</p>' +
            '<p><span class="highlight">IMPORTANT!</span> If you have ' +
            'already died, this page <span class="highlight">cannot</span> ' +
            'tell you what your stats and streaks were before death; it\'s ' +
            'impossible to get that information. If you\'d like to protect ' +
            'yourself against the effects of a death that isn\'t your ' +
            'fault, visit this page every day or every few days, and take a ' +
            'screenshot of this information or copy it to a text file.</p>' +
            '<div class="subsection"><p class="forCopyPaste">&nbsp;</p>' +
            '<h3>Your Stats</h3><ul>' +
            '<li><span>' + (Math.round(user.stats.hp  * 100) / 100) +
               '</span> Health' +
            '<li><span>' + (Math.round(user.stats.exp * 100) / 100) +
               '</span> Experience' +
            '<li><span>' + (Math.round(user.stats.gp  * 100) / 100) +
               '</span> Gold' +
            '<li><span>' + (Math.round(user.stats.mp  * 100) / 100) +
               '</span> Mana' +
            '<li><span>' + user.stats.lvl +
               '</span> Level' +
            '<li><span>' + (user.achievements.streak || 0) +
               '</span> 21-Day Streaks' +
            '</ul></div>' +
            '<div class="subsection"><p class="forCopyPaste">&nbsp;</p>' +
            '<h3>Your Dailies\' Streaks</h3><ul class="padded">';
        for (var i=0,ic=dailies.length; i<ic; i++) {
            var obj = dailies[i];
            html += '<li><span>'
                  + obj.streak + '</span> '
                  + obj.text + '</li>';
        }
        html += '</ul></div><div class="clear"></div>';
        TOC[orderId]  = {'target': id, 'title':  title};
        MAIN[orderId] = {'id': id, 'title': title, 'html': html};
    }


    function skillsAndBuffs() {
        var id      = 'skillsAndBuffsSection';
        var title   = 'Skills and Buffs';
        var orderId = 'skillsAndBuffs';
        // sectionOpen = id; //TST
        var html = '<p>This section describes the skills you have available ' +
                   'to you and the effect they will have if you cast them '+
                   'now.</p>';
        html = ''; // TST - hide the content
        if (html) { // NB: pre-level XXX users don't have skills
            TOC[orderId]  = {'target': id, 'title':  title};
            MAIN[orderId] = {'id': id, 'title': title, 'html': html};
        }
    }
}


function dropCountAndCap() {
    var id      = 'dropsTodaySection';
    var orderId = 'dropsToday';
    var title   = 'Drops Received Today';
    var html = '<p>Drops received so far today: <span class="highlight">' +
               user.items.lastDrop.count +
               '</span></p><p>Your <a '  +
               'href="http://habitrpg.wikia.com/wiki/Drops#Drop-Cap">' +
               'drop-cap</a> is <span class="highlight">';
    var dropCap = 5 + Math.floor(computedStats['per'] / 25);
    if (user.purchased.plan.planId) { // XXX_LATER better way now?
        /*  JSON SUBSCRIPTION DATA:
        NON-subscriber:
        "plan":{"mysteryItems":[],"gemsBought":0}

        subscriber awaiting termination:
        "plan":{"customerId":"cus_3qOLJ01KMSMO14",
        "dateCreated":"2014-04-13T06:58:18.017Z",
        "dateTerminated":"2014-06-01T00:00:00.000Z",
        "dateUpdated":"2014-05-01T19:43:13.762Z","paymentMethod":"Stripe",
        "planId":"basic_earned","mysteryItems":[],"gemsBought":25},

        subscriber:
        "plan":{"customerId":"cus_3qOLJ01KMSMO14",
        "dateCreated":"2014-04-13T06:58:18.017Z",
        "dateUpdated":"2014-05-01T19:43:13.762Z","paymentMethod":"Stripe",
        "planId":"basic_earned","mysteryItems":[],"gemsBought":25},
        */
        dropCap *= 2;
        html += dropCap +
               '</span>. It will increase if your <a href="' +
               'http://habitrpg.wikia.com/wiki/Perception">perception</a> ' +
               'increases. Your perception is currently <a href="' +
               'https://habitrpg.com/#/options/profile/stats">' +
               computedStats['per'] + '</a>.</p>';
    }
    else {
        html += dropCap +
               '</span>. It will become <span class="highlight">' +
               (dropCap * 2) +
               '</span> if you ' +
               '<a href="http://habitrpg.wikia.com/wiki/Subscription">' +
               'subscribe</a>. You can also increase your drop-cap slightly ' +
               'by increasing your ' +
               '<a href="http://habitrpg.wikia.com/wiki/Perception">' +
               'perception</a>.</p>';
    }

    DASHBOARD[orderId] = {'id': 'dropsTodayDashboard',
        'label': 'Drop Count / Cap',
        'hoverText': 'drops you have received so far today ' +
                     '(click for more information)',
        'target': id,
        'hidden': hideDropsInDashboard,
        'value': ((user.items.lastDrop.count || 0) +
                 '<span class="dropCap"> / ' + dropCap + '</span>'),
        'status': ((user.items.lastDrop.count &&
                    user.items.lastDrop.count >= dropCap) ? 'safe' : 'neutral')
        };

    // FOR TESTING (this does NOT contain all code for most drop chances):
    // var dropChance = 1/150+0.2  // assume new task
                   // * 1          // assume task priority easy
                   // * 1          // assume no streak
                   // * (1 + computedStats['per'] / 100)
                   // * (1 + user.achievements.streak / 200);
    // if (user.contributor.level) {
        // dropChance *= (1 + user.contributor.level / 20);
    // }
    // dropChance = diminishingReturns(dropChance, 0.75);
    // function diminishingReturns(bonus, max) {
        // var halfway = max/2;
        // var diminished = max * bonus / (bonus + halfway);
        // return diminished;
    // }

    TOC[orderId]  = {'target': id, 'title':  title};
    MAIN[orderId] = {'id': id, 'title': title, 'html': html};
}


function questProgress() {
    var id      = 'questProgressSection';
    var title   = 'Quest Progress';
    var orderId = 'questProgress';
    var html = '';
    html = '<p class="lowlight" style="margin-bottom:2.3em">Names of quests, quest bosses, and collection quest items are currently a bit messed up, due to changes in how HabitRPG stores naming data. I will be fixing this soon.</p>';
    // on a quest:
    // "quest":{"completed":null,"key":"ghost_stag",
    //          "progress":{"collect":{},"down":0,"up":13.780066986139815}},
    //
    // on a collection quest but found nothing yet:
    // "quest":{"completed":null,"key":"vice2","progress":{"collect":
    //          {"lightCrystal":0},"down":0,"up":0}},
    //
    // on a collection quest and found stuff:
    // "quest":{"completed":null,"key":"vice2","progress":{"collect":
    //          {"lightCrystal":2},"down":0,"up":2.4434153558001794}},
    //
    // not on a quest:
    // "quest":{"progress":{"collect":{},"down":0,"up":0}},
    //
    // before the user has ever joined a party or started a quest:
    // "party":{"current":null,"invitation":null,"quest":
    // {"progress":{"collect":{},"down":0,"up":0}},"order":"level"},
    //
    if (quest && quest.content.boss) { // User is on a boss quest
        var progress = Math.floor(quest.progress.up * 10) / 10;
        // We round DOWN with floor because we must never let the user
        // think they have even slightly more progress than they really
        // have. Imagine if they missed ending a quest overnight by 0.1
        // health because this page exaggerated their progress!
        html += 'So far today you have done an estimated ' +
               '<span class="highlight">' +
               progress + '</span> points of damage to ' +
               (quest.content.boss.name || quest.content.key) + '.'; // XXX 
        DASHBOARD[orderId] = {'label': title,
            'hoverText': 'amount of damage you have done to the quest boss ' +
                         'today (click for more information)',
            'target': id, 'value': progress, 'status': 'neutral'};
    }
    else if (quest && quest.content.collect) { // User is on a collection quest
        userIsOnCollectionQuest = true;
        var total = 0;
        var stuff = '';
        var uniqueItemsCount = 0;
        $.each(quest.progress.collect, function(tagId, value){
            uniqueItemsCount++;
            total += value;
            var itemName = quest.content.collect[tagId].text || tagId; // XXX 
            if (uniqueItemsCount > 1) { // we have stuff already
                stuff += ", ";
            }
            itemName = pluralise(itemName, value);
            stuff += value + " " + itemName;
        });
        var replaceStr = (uniqueItemsCount > 2) ? ", and" : " and";
        stuff = stuff.replace(/(.+),/, "$1" + replaceStr);
        html += 'So far today you have found ' + '<span class="highlight">';
        if (total == 0) {
            html += 'no items';
        }
        else {
            html += stuff;
        }
        html += '</span> for the ' +
                (quest.content.text || quest.content.key) + ' quest.'; // XXX 
        DASHBOARD[orderId] = {'label': title,
            'hoverText': 'number of items you have found today for your ' +
                         'collection quest (click for more information)',
            'target': id, 'value': total, 'status': 'neutral'};
    }
    else { // user is not on a quest
        return;
    }
    TOC[orderId]  = {'target': id, 'title':  title};
    MAIN[orderId] = {'id': id, 'title': title, 'html': html };
}


function unallocatedPoints() {
    if (user.stats.points < 1 || user.stats.lvl < 10) {
        return; // there are no points that the user can allocate
    }
    var id      = 'unallocatedPointsSection';
    var title   = 'Unallocated Points';
    var orderId = 'unallocatedPoints';
    DASHBOARD[orderId] = {'label': title,
        'hoverText': 'points you have obtained from leveling up - go to ' +
                     'your Profile -> Stats page to allocate them ' +
                     '(click for more information)',
        'target': id, 'value': user.stats.points, 'status': 'neutral'};
    TOC[orderId]  = {'target': id, 'title':  title};
    MAIN[orderId] = {'id': id, 'title': title, 'html':
    '<p><span class="highlight">You have ' +
    user.stats.points +
    ' unallocated ' +
    pluralise('point', user.stats.points) +
    '.</span> Go to <a href="https://habitrpg.com/#/options/profile/stats">' +
    'your Profile -&gt; Stats page</a> to allocate ' +
    pluralise('it', user.stats.points) +
    '. <a href="http://habitrpg.wikia.com/wiki/Character_Attributes">' +
    'Learn more.</a></p>'
    };
}


function analyseEquipment() {
    var missing = []; // gear lost due to death or rebirth
    var owned   = []; // gear actually owned right now
    $.each(user.items.gear.owned, function(key, value){
        if (value === false) {
            missing.push( prettyPrintKey(key, 'gear',
                            {'includeStats':true, 'includeGold':true, }) );
        }
        else {
            owned.push(key);
        }
    });
    missingEquipment(missing);
    currentEquipmentAndAppearance();
    recommendedEquipment(owned);


    function missingEquipment(equipment) {
        if (equipment.length < 1) {
            return; // no missing gear
        }
        var html = '<p>You are missing this equipment: ';
        if (equipment.length == 1) {
            html += '<span class="gearList">' + equipment[0] + '</span></p>';
        }
        else {
            html += '</p><ul class="gearList"><li>' +
                    equipment.join('</li><li>') +
                    '</li></ul>';
        }
        html += '<p><a href="http://habitrpg.wikia.com/wiki/' +
                'Death_Mechanics#Lost_Equipment">Learn more.</a></p>';
        if (user.achievements.rebirths > 0 && equipment.length > 6) {
            // We show the message below when rebirthers are missing
            // lots of gear, but not when they've bought back most of it,
            // because by that time, they're unlikely to be confused by
            // a long list of missing items, and the items are more and
            // more likely to be missing due to actual, recent deaths.
            html += '<p>You have used an Orb of Rebirth'
                + ' so this list will include all the equipment you owned'
                + ' in your previous life that you have not yet repurchased.'
                + ' Unfortunately it is not currently possible to limit'
                + ' this list to recent death-induced losses - but'
                + ' I have some interesting ideas to work on...</p>';
        }
        var id    = 'missingEquipmentSection';
        var title = 'Missing Equipment';
        var orderId = 'missingEquipment';
        TOC[orderId] = {'target': id, 'title':  title};
        MAIN[orderId] = {'id': id, 'title': title, 'html':html};
    }


    function currentEquipmentAndAppearance() {
        // define avatar appearance options:
        var pastels = ['pblue','pgreen','porange','ppink','ppurple','pyellow'];
        var basicSkins = {'ddc994':'palest brown (1st)','f5a76e':'pink (2nd)',
                'ea8349':'orange (3rd)','c06534':'light brown (4th)',
                '98461a':'medium brown (5th)','915533':'dark brown (6th)',
                'c3e1dc':'blue (7th)','6bd049':'green (8th)'};
        var rainbowSkins = {'eb052b':'red','f69922':'orange','f5d70f':'yellow',
                '0ff591':'green','2b43f6':'blue','d7a9f7':'pink',
                '800ed0':'violet','rainbow':'rainbow'};
        var spookySkins= ['monster','pumpkin','skeleton','zombie',
                'ghost','shadow'];

        // collate appearance elements:
        var appearance = [ 'class: <span class="attributeValue">'
                          + userKlassPretty + '</span>' ];
        if (user.stats.buffs.snowball) {
            appearance.push('<span class="attributeValue">Snowball!</span>');
        }
        $.each([
            ['',      'size',         'build'                     ],
            ['',      'shirt',        'shirt'                     ],
            ['hair',  'color',        'hair colour'               ],
            ['hair',  'bangs',        'bangs',     'convertNumber'],
            ['hair',  'base',         'hair base', 'convertNumber'],
            ['hair',  'flower',       'flower',    'convertNumber'],
            ['hair',  'mustache',     'mustache',  'convertNumber'],
            ['hair',  'beard',        'beard',     'convertNumber'],
            ['',      'skin',         'skin colour'               ],
        ], function(index,obj) {
            var value;
            if (obj[0]) { value = user.preferences[obj[0]][obj[1]]; }
            else        { value = user.preferences[obj[1]];         }
            if (obj[1] == 'color' && ($.inArray(value, pastels) !== -1)) {
                value = value.replace(/^p/, "pastel ");
            }
            if (obj[3] == 'convertNumber') {
                value = convertCardinalToOrdinal(++value); // start from 1 not 0
                if (value == '1st') { value += ' (none)'; }
            }
            if (obj[1] == 'skin') {
                if ($.inArray(value, spookySkins) !== -1) {
                    value = 'spooky: ' + value;
                }
                else if (rainbowSkins[value]) {
                    value = 'rainbow: ' + rainbowSkins[value];
                }
                else if (basicSkins[value]) {
                    value = 'basic: ' + basicSkins[value];
                }
                // if no match, we use the skin key (e.g., f133ee)
            }
            if (value) {
                appearance.push(obj[2] + ': <span class="attributeValue">'
                                       + value + '</span>');
            }
        });

        var html = '';
        if (appearance.length > 0) {
            html += '<div class="subsection">'
                  + '<p class="forCopyPaste">&nbsp;</p>'
                  + '<h3>Avatar</h3><ul><li>'
                  + appearance.join('</li><li>')
                  + '</li></ul></div>';
        }

        var equipped = prettyPrintGear(user.items.gear.equipped);
        if (equipped) {
            html += '<div class="subsection gearList">'
                  + '<p class="forCopyPaste">&nbsp;</p>'
                  + '<h3>Battle Gear</h3>'
                  + equipped
                  + '</div>';
        }

        if (user.preferences.costume) {
            var costume = prettyPrintGear(user.items.gear.costume);
            if (costume) {
                html += '<div class="subsection gearList">'
                      + '<p class="forCopyPaste">&nbsp;</p>'
                      + '<h3>Costume</h3>'
                      + costume
                      + '</div>';
            }
        }

        var beasts = [];
        $.each([ 'currentMount', 'currentPet' ], function(index,type) {
            var value = user.items[type];
            if (value) {
                // improve display of beasts (BearCub-Red -> Red Bear Cub):
                var speciesAndColour = value.split('-');
                value = speciesAndColour[1] + speciesAndColour[0];
                value = value.replace(/([A-Z])/g, " $1"); // spaces before Caps
                value += (type == 'currentPet') ? ' pet' : ' mount';
                beasts.push(value);
            }
        });
        if (beasts.length > 0) {
            html += '<div class="subsection">'
                  + '<p class="forCopyPaste">&nbsp;</p>'
                  + '<h3>Beasts</h3><ul><li>'
                  + beasts.join('</li><li>')
                  + '</li></ul></div>';
        }
        html += '<div class="clear"></div>'

        var id    = 'currentGearSection';
        var title = 'Current Appearance and Gear';
        var orderId = 'currentGear';
        TOC[orderId] = {'target': id, 'title':  title};
        MAIN[orderId] = {'id': id, 'title': title, 'html': html};

        return;


        function convertCardinalToOrdinal(num) {
            var numStr = num.toString();
            var last   = numStr.slice(-1);
            var len    = numStr.length;
            var ord    = '';
            switch (last) {
                case '1':
                    ord = numStr.slice(-2) === '11' ? 'th' : 'st';
                    break;
                case '2':
                    ord = numStr.slice(-2) === '12' ? 'th' : 'nd';
                    break;
                case '3':
                    ord = numStr.slice(-2) === '13' ? 'th' : 'rd';
                    break;
                default:
                    ord = 'th';
                    break;
            }
            return num.toString() + ord;
        }


        function prettyPrintGear(origObj, nakedMessage) {
            var obj = $.extend({}, origObj);
            var result = [];
            // Go through gear in a specific order, and then handle any gear we
            // missed (e.g., if there's a new type of gear):
            $.each(['head','headAccessory','armor','weapon','shield','back'
            ], function(index,gearType){
                if (obj[gearType]) {
                    var html = prettyPrintOneGear(obj[gearType]);
                    if (html) { result.push(html); }
                    delete obj[gearType];
                }
            });
            $.each(obj, function(index,value){
                var html = prettyPrintOneGear(value);
                if (html) { result.push(html); }
            });

            if (result.length > 0) {
                return '<ul><li>'
                     + result.join('</li><li>')
                     + '</li></ul>';
            }
            else if (nakedMessage) {
                return '<p>' + nakedMessage + '</p>';
            }
            else {
                return false;
            }


            function prettyPrintOneGear(key) {
                if (key.match(/_base_0$/)) {
                    return false; // ignore "No Helm/Armour/etc"
                }
                var html = prettyPrintKey(key, 'gear');
                return html;
            }
        }
    }


    function recommendedEquipment(equipmentKeys) {
        var html =
'<div id="equipmentRecommendationsExplanationToggle" class="showHideToggle" data-target="equipmentRecommendationsExplanation" data-linktext="explanation">show explanation</div>' +
'<div id="equipmentRecommendationsExplanation" class="hide">' +
'    <p>This section helps you choose equipment to maximise specific attributes (for example, to maximise INT and CON before casting a healing spell).</p><p>By default, the table below shows you only the best equipment you have for each attribute. The attribute values include the class bonus for items belonging to your current class.</p><p>You can sort the table by clicking on a column heading, or filter it using the "type", "class", and "attributes" drop-down menus or the "search" text box (for more information about these features read the explanation for the Task Overview section on this page, which uses the same technology).</p><p>In addition, you can click on any row to highlight that row. This will also grey-out all other equipment that cannot be used at the same time as the item you have highlighted. However, you can still click on a grey row to change the highlighting. So, to use this table, try sorting it by the attribute you care most about, then highlight the top one or more items, and then if you care about another attribute too, re-sort by it and select more items.</p><p>All highlighted items are listed in a summary underneath the table, with the total attributes provided by those items. Next to the summary, you will find a button to clear all of your highlighted selections (it also clears the summary, so make note of it first if you need to).</p><p>Items that you are currently wearing are marked with *</p>' +
'   <div class="showHideToggle closer" data-target="equipmentRecommendationsExplanation" data-resettoggletext="equipmentRecommendationsExplanationToggle">hide explanation</div>' +
'</div>' +
'<div id="qualityFilter"><p id="onlyBestIsShowing">Only your best equipment is shown below. To maximise your attributes, choose from only those items.<br /><input id="showAllEquipment" type="submit" value="Show All of My Equipment" /></p><p id="allEquipmentIsShowing">All of your equipment is shown below. Use the "quality" drop-down menu to show only the best.</p></div>' +
'<table id="equipTable"></table>' +
'<div id="equipmentChosen"></div>' +
'<div class="clear"></div>';
// NB: id="equipTable" is necessary because DataTables inserts other table(s)
// and below we need to identify our own.

        var id      = 'equipmentRecommendationsSection';
        var title   = 'Equipment Recommendations';
        var orderId = 'equipmentRecommendations';
        TOC[orderId] = {'target': id, 'title':  title};
        MAIN[orderId] = {'id': id, 'title': title, 'html': html,
                   'function': createEquipmentRecommendationsTable};

        var aaData = collateEquipmentAndIdentifyBest(equipmentKeys);

        function createEquipmentRecommendationsTable() {
            // Use DataTables to build the table (the table tag must be
            // visible first for layout to be correct):
            $('#equipmentRecommendationsSection').show();
            $('#equipmentRecommendationsSection table').dataTable({
                'fnRowCallback':
                    function(nRow, aData, iDisplayIndex, iDisplayIndexFull ) {
                        // give each row a class based on the type of gear:
                        // and another based on the quality ('best', etc):
                        $(nRow).addClass(aData['type']);
                        $(nRow).addClass(aData['quality']);
                        // add 'data' to each row for later calculations etc:
                        $(nRow).data('type', aData['type']);
                        $(nRow).data('name', aData['text']);
                        $(nRow).data('con',  aData['con']);
                        $(nRow).data('int',  aData['int']);
                        $(nRow).data('per',  aData['per']);
                        $(nRow).data('str',  aData['str']);
                        return nRow;
                    },
                'aaData': aaData,
                'aoColumns': [
            { 'sTitle': 'type',       'sClass': 'center',
              'mData': function ( source, type, val ) {
                if (type === 'set') {
                  return; // http://datatables.net/ref#mData
                }
                return (source.type == 'weaponTwoHanded') ? 'weapon two-handed'
                     : (source.type == 'headAccessory'  ) ? 'head accessory'
                     :  source.type;
              }
            },
            { 'mData' : 'text',       'sClass': 'center',
              'sTitle': 'name',
            },
            { 'mData' : 'klass',      'sClass': 'center',
              'sTitle': 'class',
            },
            { 'mData' : 'con',        'sClass': 'center',
              'sTitle': 'CON',        'asSorting': ['desc','asc'],
            },
            { 'mData' : 'int',        'sClass': 'center',
              'sTitle': 'INT',        'asSorting': ['desc','asc'],
            },
            { 'mData' : 'per',        'sClass': 'center',
              'sTitle': 'PER',        'asSorting': ['desc','asc'],
            },
            { 'mData' : 'str',        'sClass': 'center',
              'sTitle': 'STR',        'asSorting': ['desc','asc'],
            },
            { 'mData' : 'attributesString',    'bVisible': false,
              'sTitle': 'attributes', 'sClass': 'center',
            },
            { 'mData' : 'quality',    'sClass': 'center',
              'sTitle': 'quality',
            },
                ],
                'sDom': 'W<"clear"><"top"f>rt<"bottom"><"clear">',
                'bAutoWidth': false,
                'bPaginate': false,
                'bDeferRender': true,
                "sScrollX": "100%",
                "bDestroy": true,
                'oColumnFilterWidgets': {
                    'aiExclude': [ 1,3,4,5,6 ],
                    "sSeparator": "\\s*/+\\s*",
                }
            });
            $('#equipmentRecommendationsSection').hide();

            $('#equipmentRecommendationsSection table tr.stats-free')
                                    .addClass('equipmentRecommendationsHide');
            $('#equipmentRecommendationsSection table tr.middling')
                                    .addClass('equipmentRecommendationsHide');
            $('#equipmentRecommendationsSection select.widget-8')
                                    .addClass('equipmentRecommendationsHide');

            $('#showAllEquipment').click(function(event) {
                event.preventDefault();
                $('#equipmentRecommendationsSection table tr.best td')
                                .addClass('equipmentRecommendationsHighlight');
                $('#equipmentRecommendationsSection table tr.stats-free')
                                .removeClass('equipmentRecommendationsHide');
                $('#equipmentRecommendationsSection table tr.middling')
                                .removeClass('equipmentRecommendationsHide');
                $('#equipmentRecommendationsSection select.widget-8')
                                .removeClass('equipmentRecommendationsHide');
                $('#qualityFilter #onlyBestIsShowing').hide();
                $('#qualityFilter #allEquipmentIsShowing').show();
            });

            var twoHandedWeaponSelected = false;
            var oneHandedWeaponSelected = false;
            var shieldSelected          = false;
            $('#equipmentRecommendationsSection table#equipTable').on(
                                                'click', 'tr', function() {
                var type = $(this).data('type'); // armor, shield, etc
                if (! $(this).hasClass('rowHighlight')) {
                    // The user has clicked on a row that is not yet
                    // highlighted (i.e., the user wants that row to be
                    // highlighted). We add the highlight class to that row
                    // and remove it from any other rows for the same type of
                    // equipment. We add the lowlight class to all other
                    // rows for the same type of equipment (but not the row
                    // that the user clicked on).
                    $(this).siblings('.' + type).removeClass('rowHighlight')
                                                   .addClass('rowLowlight');
                    $(this).removeClass('rowLowlight')
                              .addClass('rowHighlight');
                    if (type == 'weaponTwoHanded') {
                        // The user has selected a two-handed weapon, so
                        // all shields and one-handed weapons are treated in
                        // the same way as non-selected two-handed weapons:
                        $(this).siblings('.shield').removeClass('rowHighlight')
                                                      .addClass('rowLowlight');
                        $(this).siblings('.weapon').removeClass('rowHighlight')
                                                      .addClass('rowLowlight');
                        twoHandedWeaponSelected = true;
                        oneHandedWeaponSelected = false;
                        shieldSelected          = false;
                    }
                    else if (type == 'weapon') {
                        // The user has selected a one-handed weapon, so
                        // all two-handed weapons are treated in the same way
                        // as non-selected one-handed weapons:
                        $(this).siblings('.weaponTwoHanded')
                                                .removeClass('rowHighlight')
                                                   .addClass('rowLowlight');
                        if (twoHandedWeaponSelected) {
                            // The user had previously selected a two-handed
                            // weapon, so shields would have been greyed out
                            // because of that, so now we must mark shields as
                            // able to be selected:
                            $(this).siblings('.shield')
                                                .removeClass('rowLowlight');
                            twoHandedWeaponSelected = false;
                        }
                        oneHandedWeaponSelected = true;
                    }
                    else if (type == 'shield') {
                        // The user has selected a shield, so
                        // all two-handed weapons are treated in the same way
                        // as non-selected shields:
                        // two-handed weapons as not able to be selected:
                        $(this).siblings('.weaponTwoHanded')
                                                   .removeClass('rowHighlight')
                                                      .addClass('rowLowlight');
                        if (twoHandedWeaponSelected) {
                            // The user had previously selected a two-handed
                            // weapon, so weaponds would have been greyed out
                            // because of that, so now we must mark weaponds as
                            // able to be selected:
                            $(this).siblings('.weapon')
                                                   .removeClass('rowLowlight');
                            twoHandedWeaponSelected = false;
                        }
                        shieldSelected = true;
                    }
                }
                else {
                    // The user has clicked on a row that was previously
                    // highlighted (i.e., that the user had previously clicked
                    // on) - so the user wants this row to no longer be
                    // highlighted. We remove the highlight class from the row.
                    // We also remove the lowlight class from rows for the same
                    // equipment type.
                    $(this).siblings('.' + type).removeClass('rowHighlight')
                                                .removeClass('rowLowlight');
                    $(this).removeClass('rowHighlight')
                           .removeClass('rowLowlight');
                    if (type == 'weaponTwoHanded') {
                        // The user has un-selected a two-handed weapon, so
                        // all shields and one-handed weapons (which were
                        // previously marked as unable to be selected) must
                        // have their lowlighting removed:
                        $(this).siblings('.shield').removeClass('rowLowlight');
                        $(this).siblings('.weapon').removeClass('rowLowlight');
                        twoHandedWeaponSelected = false;
                    }
                    else if (type == 'weapon') {
                        // The user has un-selected a one-handed weapon,
                        // so all two-handed weapons have their lowlighting
                        // removed UNLESS a shield is still selected:
                        if (! shieldSelected) {
                            $(this).siblings('.weaponTwoHanded')
                                                .removeClass('rowLowlight');
                        }
                        oneHandedWeaponSelected = false;
                    }
                    else if (type == 'shield') {
                        // The user has un-selected a shield,
                        // so all two-handed weapons have their lowlighting
                        // removed:
                        // UNLESS a one-handed weapon is still selected:
                        if (! oneHandedWeaponSelected) {
                            $(this).siblings('.weaponTwoHanded')
                                                .removeClass('rowLowlight');
                        }
                        shieldSelected = false;
                    }
                }
                sumEquipmentRecommendations();
            });

            return;
        }

        function sumEquipmentRecommendations() {
            var countCon    = 0;
            var countInt    = 0;
            var countPer    = 0;
            var countStr    = 0;
            var list        = '';
            $('#equipmentRecommendationsSection table tr.rowHighlight').each(
                function(index,value){
                    list        += '<li>' + $(this).data('name') + '</li>';
                    countCon    += $(this).data('con');
                    countInt    += $(this).data('int');
                    countPer    += $(this).data('per');
                    countStr    += $(this).data('str');
            });
            $('#equipmentRecommendationsSection #equipmentChosen').html(
                '<p><input id="equipmentChosenClear" type="submit"' +
                ' value="Clear All Selections" /></p>' +
                '<p>The equipment you have selected<br />' +
                'and the total stats they give are:</p>' +
                '<ul><li class="highlight">' +
                countCon + ' <span class="attributeName">con</span> ' +
                countInt + ' <span class="attributeName">int</span> ' +
                countPer + ' <span class="attributeName">per</span> ' +
                countStr + ' <span class="attributeName">str</span> ' +
                '<br /> &nbsp; ' +
                (countCon + countInt) +
                ' <span class="attributeName">con+int</span></li>' +
                list +
                '</ul>'
            );
            $('#equipmentChosenClear').click( function(event) {
                event.preventDefault();
                twoHandedWeaponSelected = false;
                oneHandedWeaponSelected = false;
                shieldSelected          = false;
                $('#equipmentRecommendationsSection table tr').each(
                    function(index,value){
                        $(value).removeClass('rowHighlight')
                                .removeClass('rowLowlight')
                    }
                )
                $('#equipmentRecommendationsSection #equipmentChosen'
                        ).html('');
            });
        }

        function collateEquipmentAndIdentifyBest(equipmentKeys) {
            var template1 = {'stat':0, 'key':'', 'obj':{}};
            var template2 = { 'con': template1, // NB: the extend() 'deep copy'
                              'int': template1, // below will expand these
                              'per': template1, // out so they are no longer
                              'str': template1, // references to one object.
                            };
            var topEquipment = {
                'armor':           $.extend(true, {}, template2),
                'head':            $.extend(true, {}, template2),
                'shield':          $.extend(true, {}, template2),
                'weapon':          $.extend(true, {}, template2),
                'weaponTwoHanded': $.extend(true, {}, template2),
            };
            var multiStatEquipment = []; // holds obj's

            var potentialItems = {};
            var allItems = []; // currently just for testing
            var equipmentObjs = [];
            $.each(equipmentKeys, function(index,key){
                var obj = $.extend({}, content.gear.flat[key]);
                obj.text = prettyPrintKey(key, 'gear', {'nameOnly':true});

                // adjust some equipment types:
                if (obj.type == 'weapon' && obj.twoHanded) {
                    obj.type = 'weaponTwoHanded';
                }

                // adjust equipment class && add class bonus:
                if (obj.klass == 'special') {
                    // use the real character class for this item:
                    obj.klass = obj.specialClass || 'none';
                }
                if (obj.klass == userKlass) { // apply class bonus:
                    obj['con'] *= 1.5;
                    obj['int'] *= 1.5;
                    obj['per'] *= 1.5;
                    obj['str'] *= 1.5;
                }
                if (obj.klass == 'wizard') {
                    obj.klass = 'mage';
                }

                // adjust equipment names
                if (obj.type == 'weaponTwoHanded') {
                    obj.text += ' <span class="lowlight">(two-handed)</span>';
                }
                if (obj.text =='Black Leather' || obj.text =='Oiled Leather') {
                    obj.text += ' '  // add type of gear to the name:
                              + upperCaseFirst(obj.type);
                }
                if (obj.klass == 'rogue' &&
                        (obj.type == 'weapon' || obj.type == 'shield')) {
                    obj.text += ' <span class="lowlight">('
                              + obj.type + '-hand)</span>';
                    // e.g., 'Kukri (shield-hand)' and 'Kukri (weapon-hand)'
                }

                // identify equipment already being worn:
                if (equippedKeys[key]) {
                    obj.text += ' *';
                }

                // categorise the item's quality according to the stats it
                // gives ('best', 'middling', 'stats-free'):
                if ((obj.con + obj.int + obj.per + obj.str) == 0) {
                    obj['quality'] = 'stats-free';
                    obj.attributesString = ''; // boosts no attributes
                }
                else {
                    // create a field that lists in one string the attributes
                    // given by this item (for a filter drop-down menu):
                    var attrs = [];
                    $.each(['con','int','per','str'], function(index, attr){
                        if (obj[attr]) {
                            attrs.push(attr);
                        }
                    });
                    obj.attributesString = attrs.join(' / ');

                    // Use item's stats to work out if it's the best we've
                    // found so far for this type, and if so, record its data
                    // (overwriting previously-found, less-good items).
                    // Also check to see how many kinds of attributes it
                    // gives - if more than two, we want it regardless of
                    // whether any of the attributes are best (gear that gives
                    // three or four attributes can be used for balanced stats).
                    var attributeCount = 0;
                    $.each(['con','int','per','str'], function(index, attr){
                        // NB: the adjustment above from 'weapon' to
                        // 'weaponTwoHanded' lets us capture the best gear
                        // for both one-hand and two-hand weapons:
                        if (obj[attr] > topEquipment[obj.type][attr]['stat']) {
                            topEquipment[obj.type][attr]['stat'] = obj[attr];
                            topEquipment[obj.type][attr]['key']  = key;
                            topEquipment[obj.type][attr]['obj']  = obj;
                        }
                        if (obj[attr] > 0) {
                            attributeCount++
                        }
                    });
                    if (attributeCount > 2) { // boosts more than 2 attributes
                        obj['quality'] = 'best';
                    }
                    else {
                        obj['quality'] = 'middling'; // might be changed to
                            // 'best' later when we have finished collating
                            // topEquipment
                    }
                }
                equipmentObjs.push(obj);
            });

            // mark all top equipment as being of the 'best' quality:
            $.each(topEquipment, function(index, typeObj){
                $.each(typeObj, function(index,attrObj){
                    if (attrObj['key']) {
                        attrObj['obj']['quality'] = 'best';
                        // due to the magic of objects, this correctly adjusts
                        // the information in the equipmentObjs array
                    }
                });
            });

            return equipmentObjs;
        }
    }


    function prettyPrintKey(key, itemType, options) {
        // Takes a "key" (e.g., weapon_warrior_0) from HabitRPG's "content"
        // data and returns the name of the item (and sometimes other info).
        // If the name can't be found, it treats the key as the name.
        var name = '';
        var extra = '';  // e.g., for gear: klass and type (weapon/armor/etc)
        if (itemType == 'gear') {
            var obj = content.gear.flat[key];
            try {
                var localeKey =
                        convertContentKeyToLocaleKey(key, itemType, obj);
                name = localeGear[localeKey] || key;
            }
            catch(err) {
                name = key;
            }
            if (options && options.nameOnly) {
        return name;
            }

            if (name == 'Mustaine\'s Milestone Mashing Morning Star') {
                name = '<abbr title="' + name + '">Mashing Morning Star</a>';
            }
            if (name == 'Stephen Weber\'s Shaft of the Dragon') {
                name = '<abbr title="' + name + '">Shaft of the Dragon</a>';
            }

            var type = obj.type;
            if (type == 'head') { type = 'headwear'; }
            extra = obj.klass;
            if (obj.klass == 'special' && obj.specialClass) {
                extra += " " + obj.specialClass;
            }
            extra += " " + type;
            if (options && options.includeStats) {
                extra += '; <span class="stats">'
                       + prettyPrintStats(obj,
                            {'includeGold':(options.includeGold || false)} )
                       + '</span>';
            }
        }
        var html = '<span class="item">' +
                 '<span class="name">' + name + '</span>';
        if (extra) {
            html += ' <span class="extra">(' + extra + ')</span>';
        }
        html += ' <span class="key">{' + key + '}</span></span>';
        return html;

        function prettyPrintStats(obj, options) {
            var stats = [];
            if (options && options.includeGold) {
                stats.push(obj.value + " gp");
            }
            if (obj.con) { stats.push(obj.con + " con"); }
            if (obj.int) { stats.push(obj.int + " int"); }
            if (obj.per) { stats.push(obj.per + " per"); }
            if (obj.str) { stats.push(obj.str + " str"); }
            return stats.join(", ");
        }


        function convertContentKeyToLocaleKey(key, itemType, obj) {
            if (itemType == 'gear') {
                return getGearLocaleKey(obj) || key;
            }
            // XXX convert other types of keys
            return key;

            function getGearLocaleKey(obj) {
                // "events" is from
                // dist/habitrpg-shared.js in the habitrpg-shared
                // repository, taken Thu May 15 11:18:27 EST 2014
                var events = {
                  winter: {
                    start: '2013-12-31',
                    end: '2014-02-01'
                  },
                  birthday: {
                    start: '2013-01-30',
                    end: '2014-02-01'
                  },
                  spring: {
                    start: '2014-03-21',
                    end: '2014-05-01'
                  }
                };

                // "mystery" is from
                // dist/habitrpg-shared.js in the habitrpg-shared
                // repository, taken Thu May 15 11:18:27 EST 2014
                var mystery = {
                  201402: {
                    start: '2014-02-22',
                    end: '2014-02-28'
                  },
                  201403: {
                    start: '2014-03-24',
                    end: '2014-04-01'
                  },
                  201404: {
                    start: '2014-04-24',
                    end: '2014-05-01'
                  },
                  wondercon: {
                    start: '2014-03-24',
                    end: '2014-04-01'
                  }
                };

                // "gear" is from
                // dist/habitrpg-shared.js in the habitrpg-shared
                // repository, taken Thu May 15 11:18:27 EST 2014
                function t(x) { return x; }
                var gear = {
                      weapon: {
                        base: {
                          0: {
                            text: t('weaponBase0Text'),
                            notes: t('weaponBase0Notes'),
                            value: 0
                          }
                        },
                        warrior: {
                          0: {
                            text: t('weaponWarrior0Text'),
                            notes: t('weaponWarrior0Notes'),
                            value: 0
                          },
                          1: {
                            text: t('weaponWarrior1Text'),
                            notes: t('weaponWarrior1Notes', {
                              str: 3
                            }),
                            str: 3,
                            value: 20
                          },
                          2: { text: t('weaponWarrior2Text'), notes: t('weaponWarrior2Notes', { str: 6 }), str: 6, value: 30 }, 3: { text: t('weaponWarrior3Text'), notes: t('weaponWarrior3Notes', { str: 9 }), str: 9, value: 45 }, 4: { text: t('weaponWarrior4Text'), notes: t('weaponWarrior4Notes', { str: 12 }), str: 12, value: 65 }, 5: { text: t('weaponWarrior5Text'), notes: t('weaponWarrior5Notes', { str: 15 }), str: 15, value: 90 }, 6: { text: t('weaponWarrior6Text'), notes: t('weaponWarrior6Notes', { str: 18 }), str: 18, value: 120, last: true } }, rogue: { 0: { text: t('weaponRogue0Text'), notes: t('weaponRogue0Notes'), str: 0, value: 0 }, 1: { text: t('weaponRogue1Text'), notes: t('weaponRogue1Notes', { str: 2 }), str: 2, value: 20 }, 2: { text: t('weaponRogue2Text'), notes: t('weaponRogue2Notes', { str: 3 }), str: 3, value: 35 }, 3: { text: t('weaponRogue3Text'), notes: t('weaponRogue3Notes', { str: 4 }), str: 4, value: 50 }, 4: { text: t('weaponRogue4Text'), notes: t('weaponRogue4Notes', { str: 6 }), str: 6, value: 70 }, 5: { text: t('weaponRogue5Text'), notes: t('weaponRogue5Notes', { str: 8 }), str: 8, value: 90 }, 6: { text: t('weaponRogue6Text'), notes: t('weaponRogue6Notes', { str: 10 }), str: 10, value: 120, last: true } }, wizard: { 0: { twoHanded: true, text: t('weaponWizard0Text'), notes: t('weaponWizard0Notes'), value: 0 }, 1: { twoHanded: true, text: t('weaponWizard1Text'), notes: t('weaponWizard1Notes', { int: 3, per: 1 }), int: 3, per: 1, value: 30 }, 2: { twoHanded: true, text: t('weaponWizard2Text'), notes: t('weaponWizard2Notes', { int: 6, per: 2 }), int: 6, per: 2, value: 50 }, 3: { twoHanded: true, text: t('weaponWizard3Text'), notes: t('weaponWizard3Notes', { int: 9, per: 3 }), int: 9, per: 3, value: 80 }, 4: { twoHanded: true, text: t('weaponWizard4Text'), notes: t('weaponWizard4Notes', { int: 12, per: 5 }), int: 12, per: 5, value: 120 }, 5: { twoHanded: true, text: t('weaponWizard5Text'), notes: t('weaponWizard5Notes', { int: 15, per: 7 }), int: 15, per: 7, value: 160 }, 6: { twoHanded: true, text: t('weaponWizard6Text'), notes: t('weaponWizard6Notes', { int: 18, per: 10 }), int: 18, per: 10, value: 200, last: true } }, healer: { 0: { text: t('weaponHealer0Text'), notes: t('weaponHealer0Notes'), value: 0 }, 1: { text: t('weaponHealer1Text'), notes: t('weaponHealer1Notes', { int: 2 }), int: 2, value: 20 }, 2: { text: t('weaponHealer2Text'), notes: t('weaponHealer2Notes', { int: 3 }), int: 3, value: 30 }, 3: { text: t('weaponHealer3Text'), notes: t('weaponHealer3Notes', { int: 5 }), int: 5, value: 45 }, 4: { text: t('weaponHealer4Text'), notes: t('weaponHealer4Notes', { int: 7 }), int: 7, value: 65 }, 5: { text: t('weaponHealer5Text'), notes: t('weaponHealer5Notes', { int: 9 }), int: 9, value: 90 }, 6: { text: t('weaponHealer6Text'), notes: t('weaponHealer6Notes', { int: 11 }), int: 11, value: 120, last: true } }, special: { 0: { text: t('weaponSpecial0Text'), notes: t('weaponSpecial0Notes', { str: 20 }), str: 20, value: 150, canOwn: (function(u) { var _ref; return +((_ref = u.backer) != null ? _ref.tier : void 0) >= 70; }) }, 1: { text: t('weaponSpecial1Text'), notes: t('weaponSpecial1Notes', { attrs: 6 }), str: 6, per: 6, con: 6, int: 6, value: 170, canOwn: (function(u) { var _ref; return +((_ref = u.contributor) != null ? _ref.level : void 0) >= 4; }) }, 2: { text: t('weaponSpecial2Text'), notes: t('weaponSpecial2Notes', { attrs: 25 }), str: 25, per: 25, value: 200, canOwn: (function(u) { var _ref; return (+((_ref = u.backer) != null ? _ref.tier : void 0) >= 300) || (u.items.gear.owned.weapon_special_2 != null); }) }, 3: { text: t('weaponSpecial3Text'), notes: t('weaponSpecial3Notes', { attrs: 17 }), str: 17, int: 17, con: 17, value: 200, canOwn: (function(u) { var _ref; return +((_ref = u.backer) != null ? _ref.tier : void 0) >= 300; }) }, critical: { text: t('weaponSpecialCriticalText'), notes: t('weaponSpecialCriticalNotes', { attrs: 40 }), str: 40, per: 40, value: 200, canOwn: (function(u) { var _ref; return !!((_ref = u.contributor) != null ? _ref.critical : void 0); }) },
              yeti: { event: events.winter, canOwn: (function(u) { return u.stats["class"] === 'warrior'; }), text: t('weaponSpecialYetiText'), notes: t('weaponSpecialYetiNotes', { str: 15 }), str: 15, value: 90 }, ski: { event: events.winter, canOwn: (function(u) { return u.stats["class"] === 'rogue'; }), text: t('weaponSpecialSkiText'), notes: t('weaponSpecialSkiNotes', { str: 8 }), str: 8, value: 90 }, candycane: { event: events.winter, canOwn: (function(u) { return u.stats["class"] === 'wizard'; }), twoHanded: true, text: t('weaponSpecialCandycaneText'), notes: t('weaponSpecialCandycaneNotes', { int: 15, per: 7 }), int: 15, per: 7, value: 160 }, snowflake: { event: events.winter, canOwn: (function(u) { return u.stats["class"] === 'healer'; }), text: t('weaponSpecialSnowflakeText'), notes: t('weaponSpecialSnowflakeNotes', { int: 9 }), int: 9, value: 90 }, springRogue: { event: events.spring, specialClass: 'rogue', text: t('weaponSpecialSpringRogueText'), notes: t('weaponSpecialSpringRogueNotes', { str: 8 }), value: 80, str: 8 }, springWarrior: { event: events.spring, specialClass: 'warrior', text: t('weaponSpecialSpringWarriorText'), notes: t('weaponSpecialSpringWarriorNotes', { str: 15 }), value: 90, str: 15 }, springMage: { event: events.spring, specialClass: 'wizard', twoHanded: true, text: t('weaponSpecialSpringMageText'), notes: t('weaponSpecialSpringMageNotes', { int: 15, per: 7 }), value: 160, int: 15, per: 7 }, springHealer: { event: events.spring, specialClass: 'healer', text: t('weaponSpecialSpringHealerText'), notes: t('weaponSpecialSpringHealerNotes', { int: 9 }), value: 90, int: 9 } } }, armor: { base: { 0: { text: t('armorBase0Text'), notes: t('armorBase0Notes'), value: 0 } }, warrior: { 1: { text: t('armorWarrior1Text'), notes: t('armorWarrior1Notes', { con: 3 }), con: 3, value: 30 }, 2: { text: t('armorWarrior2Text'), notes: t('armorWarrior2Notes', { con: 5 }), con: 5, value: 45 }, 3: { text: t('armorWarrior3Text'), notes: t('armorWarrior3Notes', { con: 7 }), con: 7, value: 65 }, 4: { text: t('armorWarrior4Text'), notes: t('armorWarrior4Notes', { con: 9 }), con: 9, value: 90 }, 5: { text: t('armorWarrior5Text'), notes: t('armorWarrior5Notes', { con: 11 }), con: 11, value: 120, last: true } }, rogue: { 1: { text: t('armorRogue1Text'), notes: t('armorRogue1Notes', { per: 6 }), per: 6, value: 30 }, 2: { text: t('armorRogue2Text'), notes: t('armorRogue2Notes', { per: 9 }), per: 9, value: 45 }, 3: { text: t('armorRogue3Text'), notes: t('armorRogue3Notes', { per: 12 }), per: 12, value: 65 }, 4: { text: t('armorRogue4Text'), notes: t('armorRogue4Notes', { per: 15 }), per: 15, value: 90 }, 5: { text: t('armorRogue5Text'), notes: t('armorRogue5Notes', { per: 18 }), per: 18, value: 120, last: true } }, wizard: { 1: { text: t('armorWizard1Text'), notes: t('armorWizard1Notes', { int: 2 }), int: 2, value: 30 }, 2: { text: t('armorWizard2Text'), notes: t('armorWizard2Notes', { int: 4 }), int: 4, value: 45 }, 3: { text: t('armorWizard3Text'), notes: t('armorWizard3Notes', { int: 6 }), int: 6, value: 65 }, 4: { text: t('armorWizard4Text'), notes: t('armorWizard4Notes', { int: 9 }), int: 9, value: 90 }, 5: { text: t('armorWizard5Text'), notes: t('armorWizard5Notes', { int: 12 }), int: 12, value: 120, last: true } }, healer: { 1: { text: t('armorHealer1Text'), notes: t('armorHealer1Notes', { con: 6 }), con: 6, value: 30 }, 2: { text: t('armorHealer2Text'), notes: t('armorHealer2Notes', { con: 9 }), con: 9, value: 45 }, 3: { text: t('armorHealer3Text'), notes: t('armorHealer3Notes', { con: 12 }), con: 12, value: 65 }, 4: { text: t('armorHealer4Text'), notes: t('armorHealer4Notes', { con: 15 }), con: 15, value: 90 }, 5: { text: t('armorHealer5Text'), notes: t('armorHealer5Notes', { con: 18 }), con: 18, value: 120, last: true } }, special: { 0: { text: t('armorSpecial0Text'), notes: t('armorSpecial0Notes', { con: 20 }), con: 20, value: 150, canOwn: (function(u) { var _ref; return +((_ref = u.backer) != null ? _ref.tier : void 0) >= 45; }) }, 1: { text: t('armorSpecial1Text'), notes: t('armorSpecial1Notes', { attrs: 6 }), con: 6, str: 6, per: 6, int: 6, value: 170, canOwn: (function(u) { var _ref; return +((_ref = u.contributor) != null ? _ref.level : void 0) >= 2; }) }, 2: { text: t('armorSpecial2Text'), notes: t('armorSpecial2Notes', { attrs: 25 }), int: 25, con: 25, value: 200, canOwn: (function(u) { var _ref; return +((_ref = u.backer) != null ? _ref.tier : void 0) >= 300; }) }, yeti: { event: events.winter, canOwn: (function(u) { return u.stats["class"] === 'warrior'; }), text: t('armorSpecialYetiText'), notes: t('armorSpecialYetiNotes', { con: 9 }), con: 9, value: 90 }, ski: { event: events.winter, canOwn: (function(u) { return u.stats["class"] === 'rogue'; }), text: t('armorSpecialSkiText'), notes: t('armorSpecialSkiText', { per: 15 }), per: 15, value: 90 }, candycane: { event: events.winter, canOwn: (function(u) { return u.stats["class"] === 'wizard'; }), text: t('armorSpecialCandycaneText'), notes: t('armorSpecialCandycaneNotes', { int: 9 }), int: 9, value: 90 }, snowflake: { event: events.winter, canOwn: (function(u) { return u.stats["class"] === 'healer'; }), text: t('armorSpecialSnowflakeText'), notes: t('armorSpecialSnowflakeNotes', { con: 15 }), con: 15, value: 90 }, birthday: { event: events.birthday, text: t('armorSpecialBirthdayText'), notes: t('armorSpecialBirthdayNotes'), value: 0 }, springRogue: { event: events.spring, specialClass: 'rogue', text: t('armorSpecialSpringRogueText'), notes: t('armorSpecialSpringRogueNotes', { per: 15 }), value: 90, per: 15 }, springWarrior: { event: events.spring, specialClass: 'warrior', text: t('armorSpecialSpringWarriorText'), notes: t('armorSpecialSpringWarriorNotes', { con: 9 }), value: 90, con: 9 }, springMage: { event: events.spring, specialClass: 'wizard', text: t('armorSpecialSpringMageText'), notes: t('armorSpecialSpringMageNotes', { int: 9 }), value: 90, int: 9 }, springHealer: { event: events.spring, specialClass: 'healer', text: t('armorSpecialSpringHealerText'), notes: t('armorSpecialSpringHealerNotes', { con: 15 }), value: 90, con: 15 } }, mystery: { 201402: { text: t('armorMystery201402Text'), notes: t('armorMystery201402Notes'), mystery: mystery['201402'], value: 10 }, 201403: { text: t('armorMystery201403Text'), notes: t('armorMystery201403Notes'), mystery: mystery['201403'], value: 10 } } }, head: { base: { 0: { text: t('headBase0Text'), notes: t('headBase0Notes'), value: 0 } }, warrior: { 1: { text: t('headWarrior1Text'), notes: t('headWarrior1Notes', { str: 2 }), str: 2, value: 15 }, 2: { text: t('headWarrior2Text'), notes: t('headWarrior2Notes', { str: 4 }), str: 4, value: 25 }, 3: { text: t('headWarrior3Text'), notes: t('headWarrior3Notes', { str: 6 }), str: 6, value: 40 }, 4: { text: t('headWarrior4Text'), notes: t('headWarrior4Notes', { str: 9 }), str: 9, value: 60 }, 5: { text: t('headWarrior5Text'), notes: t('headWarrior5Notes', { str: 12 }), str: 12, value: 80, last: true } }, rogue: { 1: { text: t('headRogue1Text'), notes: t('headRogue1Notes', { per: 2 }), per: 2, value: 15 }, 2: { text: t('headRogue2Text'), notes: t('headRogue2Notes', { per: 4 }), per: 4, value: 25 }, 3: { text: t('headRogue3Text'), notes: t('headRogue3Notes', { per: 6 }), per: 6, value: 40 }, 4: { text: t('headRogue4Text'), notes: t('headRogue4Notes', { per: 9 }), per: 9, value: 60 }, 5: { text: t('headRogue5Text'), notes: t('headRogue5Notes', { per: 12 }), per: 12, value: 80, last: true } }, wizard: { 1: { text: t('headWizard1Text'), notes: t('headWizard1Notes', { per: 2 }), per: 2, value: 15 }, 2: { text: t('headWizard2Text'), notes: t('headWizard2Notes', { per: 3 }), per: 3, value: 25 }, 3: { text: t('headWizard3Text'), notes: t('headWizard3Notes', { per: 5 }), per: 5, value: 40 }, 4: { text: t('headWizard4Text'), notes: t('headWizard4Notes', { per: 7 }), per: 7, value: 60 }, 5: { text: t('headWizard5Text'), notes: t('headWizard5Notes', { per: 10 }), per: 10, value: 80, last: true } }, healer: { 1: { text: t('headHealer1Text'), notes: t('headHealer1Notes', { int: 2 }), int: 2, value: 15 }, 2: { text: t('headHealer2Text'), notes: t('headHealer2Notes', { int: 3 }), int: 3, value: 25 }, 3: { text: t('headHealer3Text'), notes: t('headHealer3Notes', { int: 5 }), int: 5, value: 40 }, 4: { text: t('headHealer4Text'), notes: t('headHealer4Notes', { int: 7 }), int: 7, value: 60 }, 5: { text: t('headHealer5Text'), notes: t('headHealer5Notes', { int: 9 }), int: 9, value: 80, last: true } }, special: { 0: { text: t('headSpecial0Text'), notes: t('headSpecial0Notes', { int: 20 }), int: 20, value: 150, canOwn: (function(u) { var _ref; return +((_ref = u.backer) != null ? _ref.tier : void 0) >= 45; }) }, 1: { text: t('headSpecial1Text'), notes: t('headSpecial1Notes', { attrs: 6 }), con: 6, str: 6, per: 6, int: 6, value: 170, canOwn: (function(u) { var _ref; return +((_ref = u.contributor) != null ? _ref.level : void 0) >= 3; }) }, 2: { text: t('headSpecial2Text'), notes: t('headSpecial2Notes', { attrs: 25 }), int: 25, str: 25, value: 200, canOwn: (function(u) { var _ref; return +((_ref = u.backer) != null ? _ref.tier : void 0) >= 300; }) }, nye: { event: events.winter, text: t('headSpecialNyeText'), notes: t('headSpecialNyeNotes'), value: 0 }, yeti: { event: events.winter, canOwn: (function(u) { return u.stats["class"] === 'warrior'; }), text: t('headSpecialYetiText'), notes: t('headSpecialYetiNotes', { str: 9 }), str: 9, value: 60 }, ski: { event: events.winter, canOwn: (function(u) { return u.stats["class"] === 'rogue'; }), text: t('headSpecialSkiText'), notes: t('headSpecialSkiNotes', { per: 9 }), per: 9, value: 60 }, candycane: { event: events.winter, canOwn: (function(u) { return u.stats["class"] === 'wizard'; }), text: t('headSpecialCandycaneText'), notes: t('headSpecialCandycaneNotes', { per: 7 }), per: 7, value: 60 }, snowflake: { event: events.winter, canOwn: (function(u) { return u.stats["class"] === 'healer'; }), text: t('headSpecialSnowflakeText'), notes: t('headSpecialSnowflakeNotes', { int: 7 }), int: 7, value: 60 }, springRogue: { event: events.spring, specialClass: 'rogue', text: t('headSpecialSpringRogueText'), notes: t('headSpecialSpringRogueNotes', { per: 9 }), value: 40, per: 9 }, springWarrior: { event: events.spring, specialClass: 'warrior', text: t('headSpecialSpringWarriorText'), notes: t('headSpecialSpringWarriorNotes', { str: 9 }), value: 40, str: 9 }, springMage: { event: events.spring, specialClass: 'wizard', text: t('headSpecialSpringMageText'), notes: t('headSpecialSpringMageNotes', { per: 7 }), value: 40, per: 7 }, springHealer: { event: events.spring, specialClass: 'healer', text: t('headSpecialSpringHealerText'), notes: t('headSpecialSpringHealerNotes', { int: 7 }), value: 40, int: 7 } }, mystery: { 201402: { text: t('headMystery201402Text'), notes: t('headMystery201402Notes'), mystery: mystery['201402'], value: 10 } } }, shield: { base: { 0: { text: t('shieldBase0Text'), notes: t('shieldBase0Notes'), value: 0 } }, warrior: { 1: { text: t('shieldWarrior1Text'), notes: t('shieldWarrior1Notes', { con: 2 }), con: 2, value: 20 }, 2: { text: t('shieldWarrior2Text'), notes: t('shieldWarrior2Notes', { con: 3 }), con: 3, value: 35 }, 3: { text: t('shieldWarrior3Text'), notes: t('shieldWarrior3Notes', { con: 5 }), con: 5, value: 50 }, 4: { text: t('shieldWarrior4Text'), notes: t('shieldWarrior4Notes', { con: 7 }), con: 7, value: 70 }, 5: { text: t('shieldWarrior5Text'), notes: t('shieldWarrior5Notes', { con: 9 }), con: 9, value: 90, last: true } }, rogue: { 0: { text: t('weaponRogue0Text'), notes: t('weaponRogue0Notes'), str: 0, value: 0 }, 1: { text: t('weaponRogue1Text'), notes: t('weaponRogue1Notes', { str: 2 }), str: 2, value: 20 }, 2: { text: t('weaponRogue2Text'), notes: t('weaponRogue2Notes', { str: 3 }), str: 3, value: 35 }, 3: { text: t('weaponRogue3Text'), notes: t('weaponRogue3Notes', { str: 4 }), str: 4, value: 50 }, 4: { text: t('weaponRogue4Text'), notes: t('weaponRogue4Notes', { str: 6 }), str: 6, value: 70 }, 5: { text: t('weaponRogue5Text'), notes: t('weaponRogue5Notes', { str: 8 }), str: 8, value: 90 }, 6: { text: t('weaponRogue6Text'), notes: t('weaponRogue6Notes', { str: 10 }), str: 10, value: 120, last: true } }, wizard: {}, healer: { 1: { text: t('shieldHealer1Text'), notes: t('shieldHealer1Notes', { con: 2 }), con: 2, value: 20 }, 2: { text: t('shieldHealer2Text'), notes: t('shieldHealer2Notes', { con: 4 }), con: 4, value: 35 }, 3: { text: t('shieldHealer3Text'), notes: t('shieldHealer3Notes', { con: 6 }), con: 6, value: 50 }, 4: { text: t('shieldHealer4Text'), notes: t('shieldHealer4Notes', { con: 9 }), con: 9, value: 70 }, 5: { text: t('shieldHealer5Text'), notes: t('shieldHealer5Notes', { con: 12 }), con: 12, value: 90, last: true } }, special: { 0: { text: t('shieldSpecial0Text'), notes: t('shieldSpecial0Notes', { per: 20 }), per: 20, value: 150, canOwn: (function(u) { var _ref; return +((_ref = u.backer) != null ? _ref.tier : void 0) >= 45; }) }, 1: { text: t('shieldSpecial1Text'), notes: t('shieldSpecial1Notes', { attrs: 6 }), con: 6, str: 6, per: 6, int: 6, value: 170, canOwn: (function(u) { var _ref; return +((_ref = u.contributor) != null ? _ref.level : void 0) >= 5; }) }, yeti: { event: events.winter, canOwn: (function(u) { return u.stats["class"] === 'warrior'; }), text: t('shieldSpecialYetiText'), notes: t('shieldSpecialYetiNotes', { con: 7 }), con: 7, value: 70 }, ski: { event: events.winter, canOwn: (function(u) { return u.stats["class"] === 'rogue'; }), text: t('weaponSpecialSkiText'), notes: t('weaponSpecialSkiNotes', { str: 8 }), str: 8, value: 90 }, snowflake: { event: events.winter, canOwn: (function(u) { return u.stats["class"] === 'healer'; }), text: t('shieldSpecialSnowflakeText'), notes: t('shieldSpecialSnowflakeNotes', { con: 9 }), con: 9, value: 70 }, springRogue: { event: events.spring, specialClass: 'rogue', text: t('shieldSpecialSpringRogueText'), notes: t('shieldSpecialSpringRogueNotes', { str: 8 }), value: 80, str: 8 }, springWarrior: { event: events.spring, specialClass: 'warrior', text: t('shieldSpecialSpringWarriorText'), notes: t('shieldSpecialSpringWarriorNotes', { con: 7 }), value: 70, con: 7 }, springHealer: { event: events.spring, specialClass: 'healer', text: t('shieldSpecialSpringHealerText'), notes: t('shieldSpecialSpringHealerNotes', { con: 9 }), value: 70, con: 9 } } }, back: { base: { 0: { text: t('backBase0Text'), notes: t('backBase0Notes'), value: 0 } }, mystery: { 201402: { text: t('backMystery201402Text'), notes: t('backMystery201402Notes'), mystery: mystery['201402'], value: 10 }, 201404: { text: t('backMystery201404Text'), notes: t('backMystery201404Notes'), mystery: mystery['201404'], value: 10 } }, special: { wondercon_red: { text: t('backSpecialWonderconRedText'), notes: t('backSpecialWonderconRedNotes'), value: 0, mystery: mystery.wondercon }, wondercon_black: { text: t('backSpecialWonderconBlackText'), notes: t('backSpecialWonderconBlackNotes'), value: 0, mystery: mystery.wondercon } } }, body: { base: { 0: { text: t('bodyBase0Text'), notes: t('bodyBase0Notes'), value: 0 } }, special: { wondercon_red: { text: t('bodySpecialWonderconRedText'), notes: t('bodySpecialWonderconRedNotes'), value: 0, mystery: mystery.wondercon }, wondercon_gold: { text: t('bodySpecialWonderconGoldText'), notes: t('bodySpecialWonderconGoldNotes'), value: 0, mystery: mystery.wondercon }, wondercon_black: { text: t('bodySpecialWonderconBlackText'), notes: t('bodySpecialWonderconBlackNotes'), value: 0, mystery: mystery.wondercon } } }, headAccessory: { base: { 0: { text: t('headAccessoryBase0Text'), notes: t('headAccessoryBase0Notes'), value: 0, last: true } }, special: { springRogue: { event: events.spring, specialClass: 'rogue', text: t('headAccessorySpecialSpringRogueText'), notes: t('headAccessorySpecialSpringRogueNotes'), value: 20 }, springWarrior: { event: events.spring, specialClass: 'warrior', text: t('headAccessorySpecialSpringWarriorText'), notes: t('headAccessorySpecialSpringWarriorNotes'), value: 20 }, springMage: { event: events.spring, specialClass: 'wizard', text: t('headAccessorySpecialSpringMageText'), notes: t('headAccessorySpecialSpringMageNotes'), value: 20 }, springHealer: { event: events.spring, specialClass: 'healer', text: t('headAccessorySpecialSpringHealerText'), notes: t('headAccessorySpecialSpringHealerNotes'), value: 20 }, wondercon_red: { text: t('headAccessorySpecialWonderconRedText'), notes: t('headAccessorySpecialWonderconRedNotes'), value: 0, mystery: mystery.wondercon }, wondercon_black: { text: t('headAccessorySpecialWonderconBlackText'), notes: t('headAccessorySpecialWonderconBlackNotes'), value: 0, mystery: mystery.wondercon } }, mystery: { 201403: { text: t('headAccessoryMystery201403Text'), notes: t('headAccessoryMystery201403Notes'), mystery: mystery['201403'], value: 10 }, 201404: { text: t('headAccessoryMystery201404Text'), notes: t('headAccessoryMystery201404Notes'), mystery: mystery['201404'], value: 10 } } }
                };

                return gear[obj.type][obj.klass][obj.index].text;
            }
        }
    }
}



function computeStats() {
    var computedStats = [];
    computedStats['con'] = computeStat('con');
    computedStats['int'] = computeStat('int');
    computedStats['per'] = computeStat('per');
    computedStats['str'] = computeStat('str');
    return computedStats;

    function computeStat(stat) {
        var computed = user.stats[stat]
                     + user.stats.buffs[stat]
                     + ((user.stats.lvl - 1) / 2);
        // get appropriate stat for each piece of Battle Gear:
        for(var key in equippedKeys) {
            var obj = equippedKeys[key];
            var value = obj[stat];
            if (obj.klass == userKlass || obj.specialClass == userKlass ) {
                value *= 1.5;
            }
            computed += value;
        }
        return computed;
    }
}

} // end of parseData() and its nested functions
});
</script>

<style>

/*********************************************************************
****   Page-wide   ***************************************************
*********************************************************************/
body {
    font-family: Helvetica, Arial, sans-serif;
    font-size: 14px;
    background-color: rgb(173, 208, 215);
}
#innerBody {
    margin: 20px;
    padding: 5px 20px 30px 20px;
    background-color: rgb(242, 242, 230);
}
#loading {
    margin-right: 30px;
    margin-left: 30px;
    color: orange;
    font-size: 1.5em;
    font-weight: bold;
}
.narrowContent {      /* The data should be as wide as the user's window   */
    max-width: 500px; /* but some explanatory paragraphs should be narrow. */
}


hr {
    width: 95%;
}
hr.padded {
    margin-top:    1em;
    margin-bottom: 2em;
}

.show {
    display: block;
}
.hide {
    display: none;
}
.clear {
    clear: both;
}

.subheading {
    font-weight: bold;
}
.highlight {
    font-weight: bold;
}
.lowlight { /* like highlight but less so */
    font-style: italic;
}
.explanation {
    font-style: italic;
}
abbr {
    border-bottom: 1px dashed black;
}
img.emoji {
    margin-bottom: -0.25em;
}
.forCopyPaste {
    /* used to add blank lines that we want when copying text to clipboard,
       but we don't want to see extra whitespace on the screen */
    margin-top: -1em;
}
ul.padded > li {
    padding: 3px 0;
}

.gearList .item .stats {
    font-variant: small-caps;
}
.gearList .item .key {
    display: none;
}


.coloured {
    display: inline-block;
    width: 5.5em;
    height: 3em;
    padding-top: .7em;
}
.colourBrightBlue { background-color: rgb(209,226,248); }
.colourBlueGrey   { background-color: rgb(216,230,232); }
.colourGreen      { background-color: rgb(222,237,219); }
.colourYellow     { background-color: rgb(255,244,216); }
.colourOrange     { background-color: rgb(254,234,216); }
.colourRed        { background-color: rgb(250,214,214); }
.colourDarkRed    { background-color: rgb(240,197,190); }


/*********************************************************************
****   Page-wide Show/Hide Toggling   ********************************
*********************************************************************/
.mainSectionClose,
.showHideToggle {
    text-decoration: underline;
    color: purple;
}
.closer { /* as in "a thing that closes", not "nearer" */
    margin-top: 30px;
    padding-top: 15px;
    padding-bottom: 15px;
}
.closer:hover {
    border: 1px dashed lightgrey;
}


/*********************************************************************
****   Header   ******************************************************
*********************************************************************/
h1 {
    float: left;
}
h1>a:first-child { /* "HabitRPG" link in header */
    color: black;
    text-decoration: none;
}
h1>a:first-child:hover { /* "HabitRPG" link in header */
    text-decoration: underline;
}
h1 span {
    font-size: 0.5em;
}
h2 {
    margin-top: 30px;
}

#userNameDisplay {
    text-align: right;
    font-weight: bold;
    font-size: 2em;
    margin-bottom: 10px;
}
#emailDisplay {
    text-align: right;
    margin-bottom: 10px;
}

#explanationAndClearLinks {
    text-align: right;
}
#explanationAndClearLinks span {
    padding-left: 10px;
}


/*********************************************************************
****   Version History   *********************************************
*********************************************************************/

#versionChanges dl {
    margin-left: 30px;
}
#versionChanges dl dt {
    font-size: 1.15em;
    font-weight: bold;
}
#versionChanges dl dt .date {
    padding-left: 10px;
    font-size: 0.8em;
    font-weight: normal;
}
#versionChanges .showHideToggle {
    padding-bottom: 15px;
    margin-bottom: 10px;
}


/*********************************************************************
****   API Form and Documentation   **********************************
*********************************************************************/

#documentationAndForm > div {
    max-width: 700px;
}
#documentationAndForm #documentationAndFormClose {
    display: none;
    max-width: 100%;
}
#documentationAndForm div h2 {
    font-size: 1.3em;
}
#documentationAndForm li {
    margin-bottom: 10px;
}

#userApiDetailsForm {
    margin: 30px;
}
#userApiDetailsForm fieldset {
    max-width: 40em;
}
#userApiDetailsForm fieldset label,
#userApiDetailsForm fieldset input[type="submit"] {
    display: block;
    float: left;
    clear: left;
    margin: 10px 0;
}
#userApiDetailsForm fieldset label span {
    display: block;
    float: left;
    width: 6em;
}
#userApiDetailsForm fieldset label input {
    float: left;
    width: 30em;
}
#userApiDetailsForm fieldset p {
    clear: both;
}
#userApiDetailsForm legend .highlight {
    font-size: 1.3em;
}
#userApiDetailsForm fieldset li {
    margin-bottom: 7px;
}


/*********************************************************************
****   Dashboard   ***************************************************
*********************************************************************/

#DASHBOARD ul {
    float: left;
}
#DASHBOARD li {
    text-align: center;
    width: 120px;
    background-color: #fffbd0; /* yellow */
    border: 1px;
    padding: 4px;
    margin-right: 4px;
    float: left;
    list-style-type: none;
}
#DASHBOARD li.showHideToggle {
    cursor: pointer;
    text-decoration: none;
    color: black;
}
#DASHBOARD li > div {
    box-shadow: 1px 1px 1px 1px #666666;
}
#DASHBOARD .value {
    font-size: 2.15em;
    font-weight: bold;
    padding: 2px;
}
#DASHBOARD .label {
    font-size: 0.75em;
    padding: 1px;
}
#DASHBOARD .neutral {
    background-color: #fffbd0; /* yellow */
}
#DASHBOARD .danger {
    background-color: #ffcccc; /* red */
}
#DASHBOARD .safe {
    background-color: #ccffcc; /* green */
}
#DASHBOARD .dropCap {
    font-size: 0.7em;
}


/*********************************************************************
****   Table Of Contents   *******************************************
*********************************************************************/

ul#tableOfContents {
    list-style-type: none;
}
ul#tableOfContents ul {
    list-style-type: none;
    margin-left: 1em;
    padding: 0;
}
ul#tableOfContents li {
    font-size: 1.1em;
    padding: 2px 0;
}
ul#tableOfContents > li {
    float: left;
    margin-right: 20px;
}


/*********************************************************************
****   Specific Sections   *******************************************
*********************************************************************/
#MAIN > * {
    display: none; // all sections hidden by default
}


#taskOverviewSection .showHideToggle {
    margin-bottom: 1em;
}
#taskOverviewSection table {
    width: 100%;
    table-layout: fixed;
    word-wrap: break-word;
}
#taskOverviewSection table .sorting_1,
#taskOverviewSection table .sorting_2,
#taskOverviewSection table .sorting_3,
#taskOverviewSection table .even {
    background-color: #FAF9F9;
}
#taskOverviewSection table .odd  {
    background-color: #FEFEFF;
}
#taskOverviewSection input {
    width: 300px;
}
#taskOverviewSection table tr th:nth-child(3),
#taskOverviewSection table tr td:nth-child(3) {
    max-width: 60px !important;
}
#taskOverviewSection h3 {
    margin-top: 3em;
}


#taskStatisticsSection h3 {
    margin-top: 2em;
}
#taskStatisticsSection table {
    border: 1px solid black;
    border-collapse: collapse;
}
#taskStatisticsSection table tr th,
#taskStatisticsSection table tr td {
    padding: 3px 7px;
    border: 1px solid black;
    text-align: center;
}
#taskStatisticsSection table tr.total td {
    font-weight: bold;
    font-size: 1.1em;
    border-top:    2px solid black;
    border-bottom: 2px solid black;
}


#habitHistorySection .buttonUsed { /* which button (+ or -) was pressed */
    font-weight: bold;
}
#habitHistorySection .historyValue {
    font-size: .8em;
}
#habitHistorySection li li {
    padding: 1px 0;
}
#habitHistorySection .noHistory {
    font-weight: bold;
}
#habitHistorySection .noHistory span {
    font-size:  .8em;
    font-style: italic;
    font-weight: normal;
}


#dailiesIncompleteSection h3 {
    margin-top: 3em;
}
#dailiesIncompleteSection ul {
    list-style-type: none;
}
#dailiesIncompleteSection #greyDailies {
    margin-top: 3em;
}


#todosDatedSection ul {
    list-style-type: none;
}
#todosDatedSection .due {
    font-weight: bold;
}
#todosDatedSection li span.date {
    display: inline-block;
    width: 7em;
}
#todosDatedSection li span.challenge {
    font-style: italic;
    font-variant: small-caps;
}


#statsAndStreaksSection .subsection {
    float: left;
    margin-left: 3em;
}
#statsAndStreaksSection ul {
    list-style-type: none;
    margin:  0;
    padding: 0;
}
#statsAndStreaksSection li span {
    display: inline-block;
    width: 4em;
}


#missingEquipmentSection ul.gearList  {
    list-style-type: none;
}
#missingEquipmentSection .gearList .item .name {
    font-weight: bold;
}
#missingEquipmentSection .gearList .item .extra {
}


#currentGearSection .subsection {
    float: left;
    margin-right: 2em;
}
#currentGearSection ul {
    list-style-type: none;
    margin:  0;
    padding: 0;
}
#currentGearSection .gearList .item .extra {
    font-style: italic;
}
#currentGearSection .attributeValue {
    font-weight: bold;
}


#equipmentRecommendationsSection #qualityFilter {
    text-align: center;
    margin-top: 2em;
    font-size: 1.2em;
}
#equipmentRecommendationsSection #allEquipmentIsShowing {
    display: none;
}
#equipmentRecommendationsSection #onlyBestIsShowing {
}
#equipmentRecommendationsSection table tr td {
    border-bottom: 1px solid lightgrey;
}
#equipmentRecommendationsSection table tr.even,
#equipmentRecommendationsSection table tr.even .sorting_1,
#equipmentRecommendationsSection table tr.even .sorting_2,
#equipmentRecommendationsSection table tr.even .sorting_3,
#equipmentRecommendationsSection table tr.even .sorting_4,
#equipmentRecommendationsSection table tr.even .sorting_5,
#equipmentRecommendationsSection table tr.even .sorting_6,
#equipmentRecommendationsSection table tr.odd,
#equipmentRecommendationsSection table tr.odd  .sorting_1,
#equipmentRecommendationsSection table tr.odd  .sorting_2,
#equipmentRecommendationsSection table tr.odd  .sorting_3,
#equipmentRecommendationsSection table tr.odd  .sorting_4,
#equipmentRecommendationsSection table tr.odd  .sorting_5,
#equipmentRecommendationsSection table tr.odd  .sorting_6 {
    background-color: rgb(242, 242, 230); /* yellowish */
    color: black;
    font-style: normal;
    font-weight: normal;
}
#equipmentRecommendationsSection table .rowLowlight,
#equipmentRecommendationsSection table .rowLowlight .sorting_1,
#equipmentRecommendationsSection table .rowLowlight .sorting_2,
#equipmentRecommendationsSection table .rowLowlight .sorting_3,
#equipmentRecommendationsSection table .rowLowlight .sorting_4,
#equipmentRecommendationsSection table .rowLowlight .sorting_5,
#equipmentRecommendationsSection table .rowLowlight .sorting_6 {
    background-color: #E8E8E8 !important; /* pale grey */
    color: #C0C0C0 !important; /* darker grey */
    font-style: italic !important;
    font-weight: normal !important;
}
#equipmentRecommendationsSection table .rowHighlight,
#equipmentRecommendationsSection table .rowHighlight .sorting_1,
#equipmentRecommendationsSection table .rowHighlight .sorting_2,
#equipmentRecommendationsSection table .rowHighlight .sorting_3,
#equipmentRecommendationsSection table .rowHighlight .sorting_4,
#equipmentRecommendationsSection table .rowHighlight .sorting_5,
#equipmentRecommendationsSection table .rowHighlight .sorting_6 {
    background-color: rgb(173, 208, 215) !important; /* bluish */
    color: black !important;
    font-style: normal !important;
    font-weight: bold !important;
}
.equipmentRecommendationsHighlight {
    font-weight: bold !important;
}
.equipmentRecommendationsHide { /* initially show only the best gear */
    display: none !important;
}

#equipmentRecommendationsSection #equipmentChosen {
    margin-top: 1.5em;
}
#equipmentRecommendationsSection #equipmentChosen p,
#equipmentRecommendationsSection #equipmentChosen ul {
    width: auto;
    float: left;
    margin-right: 2em;
}
#equipmentRecommendationsSection #equipmentChosen ul {
    list-style-type: none;
    font-size:  1.2em;
    margin: 0;
    padding: 0;
}
#equipmentRecommendationsSection #equipmentChosen ul li {
    padding-bottom: 3px;
}
#equipmentRecommendationsSection #equipmentChosen ul li.highlight {
    padding-bottom:  9px;
}
#equipmentRecommendationsSection #equipmentChosen .attributeName {
    font-variant: small-caps;
    padding-right: 10px;
}

</style>
</head>
<body><div id="innerBody">

<h1><a href="https://habitrpg.com/">HabitRPG</a> Unofficial User Data Display
    <span class="showHideToggle" data-target="versionChanges" data-closemainsections="true">(v2.1.2c)</span></h1><!-- VERSION TOGGLE -->
<div id="headerExtras"></div>
<hr class="clear" />

<div id="loading" class="narrowContent">
    <div class="good hide">
        <p>Please wait. Fetching data from
        <span id="serverName">HabitRPG</span>...</p>
        <p id="specialMessage" class="lowlight">
        "You are made of 23049% awesome"<br />-- Clara Oswald
        </p>
    </div>
    <div class="bad hide">
        <p>There was an error obtaining your data. Please
           check that your User ID and API Token are correct
           and then try again.</p>
        <p>If problems persist see <strong>Known Bugs</strong>
           and <strong>Contact Details</strong> at the bottom
           of this page. It might help to upgrade your browser
           to its latest version, if not already done.</p>
    </div>
</div>

<div id="versionChanges" class="hide"><!-- VERSION SECTION -->
    <h2>Version History</h2>
    <dl>

        <dt>2.1.2<span class="date">2014-05-15</span></dt>
        <dd><ul>
            <li>Code:
                <ul>
                    <li>(2.1.2a) Names of equipment have been fixes. Names of quests, quest bosses, and collection quest items are still not perfect, but it's easy enough to work out what they mean. I'll be fixing them properly soon.</li>
                    <li>Temporary partial bug fixes have been inserted. (HabitRPG has changed how it reports the names of equipment, quests, bosses, and other items. I'm updating this tool to match.)</li>
                </ul>
            </li>
        </ul></dd>

        <dt>2.1.1<span class="date">2014-05-14</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
                    <li>(2.1.1a) For "To-Dos with Dates", if the only "due" to-dos are from challenges and are more than a week old, then the dashboard tile will be yellow rather than red, since you're likely to not care so much about those to-dos.</li>
                    <li>At the bottom of the <span class="subheading">Task Overview</span> section, you will now find one randomly-selected item from your to-do list. Re-fetch your data to see a different random to-do.</li>
                </ul>
            </li>
        </ul></dd>
        <dt>2.1<span class="date">2014-05-13</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
                    <li><span class="subheading">To-Dos with Dates</span>: A list of all to-dos that have been given due dates, sorted by date. If there are any to-dos due today or overdue, a red tile will appear in the dashboard to tell you how many there are.</li>
                    <li><span class="subheading">Current Health</span> dashboard tile now turns red when your expected damage is greater than your health.</li>
                </ul>
            </li>
        </ul></dd>
        <dt>2.0.1<span class="date">2014-05-13</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
                    <li><span class="subheading">Dailies Incomplete</span> table is now neater and consistent in layout with the other tables.</li>
                    <li><span class="subheading">Equipment Recommendations</span> table uses asterisks to indicate the battle gear you are already wearing.</li>
                </ul>
            </li>
            <li>Code:
                <ul>
                    <li>Fixed a bug in Equipment Recommendations where clicking on a header would do weird things (table#equipTable).</li>
                </ul>
            </li>
        </ul></dd>
        <dt>2.0<span class="date">2014-05-13</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
                    <li><span class="subheading">Stats and Streaks Backup</span> gives you a plain-text view of information that you might need to restore your stats if you die through no fault of your own. Be sure to read the "IMPORTANT" warning in that section!</li>
                    <li><span class="subheading">Dashboard tiles</span> no longer appear if they're not relevant.</li>
                    <li>When you re-fetch your data, the section you had open previously will remain open.</li>
                </ul>
            </li>
            <li>Code:
                <ul>
                    <li>Large changes to the code to place each section of the page in its own function, dramatically tighten scope, reduce DOM updates, and remove some cached display errors that were happening on refetch. If you find anything working differently than expected, you can compare it with <a href="https://oldgods.net/habitrpg/habitrpg_user_data_display_1_8_4.html">the old version  (1.8.4)</a>. Please <a href="mailto:lady_alys@oldgods.net">tell me</a> about any problems!</li>
                </ul>
            </li>
        </ul></dd>
        <dt>1.8.4<span class="date">2014-05-06</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
                    <li><span class="subheading">Dailies Incomplete</span> now displays the streak count for each daily, thanks to thepeopleseason for the idea and the code.</li>
                </ul>
            </li>
            <li>Code:
                <ul>
                    <li>The emoji JavaScript library has been added to js-for-habitrpg_user_data_display.tar.gz, thanks again to thepeopleseason.</li>
                    <li>The Equipment Recommendations' "topEquipment" code has been improved and hopefully doesn't have surprising new bugs.</li>
                </ul>
            </li>
        </ul></dd>
        <dt>1.8.3<span class="date">2014-04-28</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
                    <li><span class="subheading">Emoji!</span> You should now find that <a href="http://habitrpg.wikia.com/wiki/Emoji">emoji</a> are represented properly. (<a href="http://habitrpg.wikia.com/wiki/Markdown_Cheat_Sheet">Markdown</a> is stil not supported.)</li>
                </ul>
            </li>
            <li>Documentation / Layout:
                <ul>
                    <li>"Suspected Bugs" changed to "Known Bugs" because I've found one: Internet Explorer does not correctly handle refetching data; instead you need to reload the page. Chrome, Firefox, and Safari (and probably others) do not have this issue.</li>
                </ul>
            </li>
            <li>Code:
                <ul>
                    <li>Emoji support turned out to be really easy. I should have done it weeks ago! I'm using <a href="https://github.com/HenrikJoreteg/emoji-images">HenrikJoreteg's emoji-images library</a> which gives you a quick and easy function to emojify any string.</li>
                </ul>
            </li>
        </ul></dd>
        <dt>1.8.2<span class="date">2014-04-26</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
                    <li>The <span class="subheading">Dailies Incomplete</span> section now shows the estimated damage each daily will do to you, and to your party members if you are on a <a href="http://habitrpg.wikia.com/wiki/Boss">boss</a> <a href="http://habitrpg.wikia.com/wiki/Quests">quest</a>.</li>
                </ul>
            </li>
            <li>Documentation / Layout:
                <ul>
                    <li>The explanation for Equipment Recommendations is now hidden by default.</li>
                    <li>The Unallocated Points section is no longer shown by default (some people don't use points, and for those that do, it's always visible in the dashboard).</li>
                </ul>
            </li>
        </ul></dd>
        <dt>1.8.1<span class="date">2014-04-25</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
                    <li><span class="subheading">Drops Count</span> in the dashboard now also shows you your current drop-cap (thanks to Ryan for suggesting this).</li>
                </ul>
            </li>
            <li>Documentation / Layout:
                <ul>
                    <li>In <span class="subheading">Task Statistics</span> section, fixed the incorrect information about archived to-dos (thanks to SabreCat for pointing out the error).</li>
                </ul>
            </li>
            <li>Code:
                <ul>
                    <li>Removed a few different kinds of hide/show toggling code and replaced them with one type (nearly 100 lines of code deleted!)</li>
                    <li>Fixed broken "Show All of My Equipment" button in the Equipment Recommendations section (thanks to SabreCat for the bug report).</li>
                </ul>
            </li>
        </ul></dd>
        <dt>1.8<span class="date">2014-04-23</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
                    <li><span class="subheading">Task Statistics</span>: How many habits, dailies, to-dos, and rewards you have in total, and how many are assigned to each <a href="http://habitrpg.wikia.com/wiki/Advanced_Options">attribute</a>. If you have task-based <a href="http://habitrpg.wikia.com/wiki/Automatic_Allocation">auto-allocation</a> turned on, this section will also show your <span class="subheading">Training Points</span>.</li>
                    <li><span class="subheading">Equipment Recommendations</span>: This displays your best equipment with features that help you choose the right gear for maximising specific attributes (for example, to maximise INT and CON before casting a healing spell).</li>
                </ul>
            </li>
        </ul></dd>
        <dt>1.7.2 <span class="date">2014-04-19</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
                    <li><span class="subheading">Re-Fetch My Data button</span> appears in the header after you have fetched your data once. Clicking it will refresh your data with the latest from HabitRPG's server (it has the same effect as resubmitting the API details form).</li>
                    <li><span class="subheading">Your email address</span> is in the header but hidden by default to save space. Click on the "show email address" link in the header to show it.</li>
                    <li><span class="subheading">Clear my data</span> link has been removed from the header to save space and because I don't think it was very useful (tell me if you disagree!). You can still clear your data by reloading the page (and that's documented in the "Privacy and security notes" under the API Details form).</li>
                </ul>
            </li>
        </ul></dd>
        <dt>1.7.1 <span class="date">2014-04-19</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
                    <li><span class="subheading">Your email address</span> is now displayed in the header, thanks to @thepeopleseason.</li>
                </ul>
            </li>
        </ul></dd>
        <dt>1.7 <span class="date">2014-04-18</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
                    <li><span class="subheading">A dashboard!</span> Created by @thepeopleseason (thank you!). Shows data related to dailies, quests, and other things. Hover over each dashboard box to see an explanation. Click (on most of them) to open the associated section on the page.</li>
                </ul>
            </li>
        </ul></dd>
        <dt>1.6.2 <span class="date">2014-04-13</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
                    <li><span class="subheading">Drops Received Today</span> shows you your current drop-cap (thanks to Ryan for suggesting this).</li>
                </ul>
            </li>
        </ul></dd>
        <dt>1.6.1 <span class="date">2014-04-13</span></dt>
        <dd><ul>
            <li>Features (minor):
                <ul>
                    <li><span class="subheading">Damage from Dailies</span> is now complete and seems to be accurate. But don't trust it with your life! Please read the warning in that section (click its "show explanation" link).</li>
                    <li><span class="subheading">Current Appearance and Gear</span> and <span class="subheading">Missing Equipment</span> now specify the class for special gear that has a class.</li>
                </ul>
            </li>
            <li>Documentation / Layout:
                <ul>
                    <li>Renamed <span class="subheading">Tasks that have not been Tagged</span> to <span class="subheading">Tasks Untagged</span>.</li>
                    <li><span class="subheading">Damage from Dailies</span>: Improved (I hope) wording to explain the two kinds of damage you can take (normal and boss), to help new users. Feedback welcome if it's actually become worse. You can just look at the bolded parts if you already understand what's going on.</li>
                </ul>
            </li>
            <li>Code:
                <ul>
                    <li>Initial code for a dashboard, thanks to thepeopleseason! The dashboard is currently hidden while development continues.</li>
                    <li>The page now erases generated HTML and hides optional ToC entries before data is (re-)fetched to prevent incorrect display of old data.</li>
                    <li>Various other code improvements.</li>
                </ul>
            </li>
        </ul></dd>
        <dt>1.6 <span class="date">2014-04-10</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
                    <li><span class="subheading">Dailies Incomplete</span>: Lists the dailies scheduled for today that you have not yet completed. Also has a separate list of <a href="http://habitrpg.wikia.com/wiki/Dailies#Grey_Dailies">grey dailies</a> that have not been completed. This section won't appear if you have completed all of your dailies.</li>
                </ul>
            </li>
        </ul></dd>
        <dt>1.5 <span class="date">2014-04-08</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
                    <li><span class="subheading">Current Appearance and Gear</span>: Lists the <a href="http://habitrpg.wikia.com/wiki/Equipment">equipment</a> you are wearing (battle gear and costume), your <a href="http://habitrpg.wikia.com/wiki/Profile#Avatar">avatar's appearance settings</a> (skin colour, hair, etc), and your <a href="http://habitrpg.wikia.com/wiki/Pets">pet</a> and <a href="http://habitrpg.wikia.com/wiki/Mounts">mount</a>. This lets you easily record an appearance that you especially like or a set of battle gear that gives you useful stats (e.g., you could copy and paste this section to a text file).</li>
                </ul>
            </li>
            <li>Code:
                <ul>
                    <li>Improvements to <span class="subheading">Damage from Dailies</span>. CON from gear (including class bonuses) is now included; Stealth buff is still NOT included (but will be soon). This seems pretty accurate now but there's still more testing to be done before it could be called reliable.</li>
                </ul>
            </li>
        </ul></dd>
        <dt>1.4.5 <span class="date">2014-04-06</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
                    <li><span class="subheading">Damage from Dailies</span> now includes a (wildly inaccurate?) <span class="highlight">estimate</span> of how much damage you and your fellow quest participants will take from a quest boss if you do no more dailies today. This is experimental and still being tested.</li>
                </ul>
            </li>
        </ul></dd>
        <dt>1.4.4 <span class="date">2014-04-06</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
                    <li><span class="subheading">Missing Equipment</span> contains the cost and stats for each item to help you work out if it's worth changing class to buy it back (also, layout is neater for several items)</li>
                </ul>
            </li>
            <li>Documentation / Layout:
                <ul>
                    <li>Table of Contents is split into Tasks and Other. It was threatening to become cluttered.</li>
                    <li>Table of Contents links will now hide their respective sections when clicked on a second time (consistent with all other hide/show links on the page)</li>
                    <li>Task Overview explanation is now hidden by default to save precious screen space.</li>
                </ul>
            </li>
            <li>Code:
                <ul>
                    <li>Inserted a slightly nasty hack to allow Chrome to save the User ID and API Token if the user chooses to do that. (<a href="http://www.zdnet.com/do-you-save-passwords-in-chrome-maybe-you-should-reconsider-7000019074/">Obligatory warning about problems with storing passwords in browsers</a> - be careful especially on shared computers).</li>
                    <li>HabitRPG's "content" json data is now fetched before the user data so that we can use it for displaying attractive gear names, and calculating stats from gear.</li>
                </ul>
            </li>
        </ul></dd>
        <dt>1.4.3 <span class="date">2014-04-05</span></dt>
        <dd><ul>
            <li>Features: none</li>
            <li>Code:
                <ul>
                    <li>Improvements to <span class="subheading">Damage from Dailies</span> but it's still experimental and not to be trusted. Damage reduction from checklists is now included; CON buffs are now included (but not CON gear nor Stealth)</li>
                </ul>
            </li>
        </ul></dd>
        <dt>1.4 <span class="date">2014-04-03</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
                    <li><span class="subheading">Damage from Dailies</span>: an <span class="highlight">estimate</span> of how much damage you would take if you did no more dailies today. Be cautious about using this if you are low on health! Please read the warning in that section (click its "show explanation" link).</li>
                </ul>
            </li>
        </ul></dd>
        <dt>1.3.3 <span class="date">2014-03-31</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
                    <li><span class="subheading">"show documentation and Fetch My Data form"</span>: now when you use that link, it hides any other sections that you had open, so that you can more easily get to the form. Tell me if that's inconvenient for you (Contact Details at bottom of documentation).</li>
                </ul>
            </li>
        </ul></dd>
        <dt>1.3.2 <span class="date">2014-03-31</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
                    <li><span class="subheading">"show documentation and Fetch My Data form"</span> is back and the bug that prompted me to remove it has been fixed. Thanks to <a href="http://habitrpg.wikia.com/wiki/User:BrightBold">BrightBold</a> for <a href="http://habitrpg.wikia.com/wiki/User_blog:LadyAlys/HabitRPG_Unofficial_User_Data_Display#comm-11596">explaining</a> that it was an important feature for people who use the tool a lot.</li>
                </ul>
            </li>
        </ul></dd>
        <dt>1.3.1 <span class="date">2014-03-30</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
                    <li><span class="subheading">Habit History</span> now has bolding when there's no history, as they could be habits that you need a bit more encouragement to do - thanks to <a href="http://habitrpg.wikia.com/wiki/User:Malkin">Malkin</a> for the <a href="http://habitrpg.wikia.com/wiki/User_blog:LadyAlys/HabitRPG_Unofficial_User_Data_Display#comm-11572">suggestion</a></li>
                </ul>
            </li>
            <li>Documentation:
                <ul>
                    <li>Added wiki blog post to Contact Details (you can comment on the post)</li>
                    <li><span class="subheading">show documentation</span> link (used to be "show explanations...") no longer unhides the Fetch My Data form because fetching new data over the top of old data was causing problems.</li>
                </ul>
            </li>
        </ul></dd>
        <dt>1.3 <span class="date">2014-03-30</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
                    <li><span class="subheading">Task Overview</span></li>
                </ul>
            </li>
            <li>Code:
                <ul>
                    <li>To run this page locally, you must now install <a href="http://datatables.net/">Data Tables</a> and <a href="http://legacy.datatables.net/extras/thirdparty/ColumnFilterWidgets/DataTables/extras/ColumnFilterWidgets/">ColumnFilterWidgets</a>. A cut-down version of both (e.g., no documentation) can be found <a href="https://github.com/Alys/tools-for-habitrpg/blob/master/js--for--habitrpg_user_data_display.tar.gz">on github</a>.</li>
                </ul>
            </li>
        </ul></dd>
        <dt>1.2 <span class="date">2014-03-29</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
                    <li><span class="subheading">Quest Progress</span> now works for <span class="subheading">Collection Quests</span>. While on a collection quest, opening Drops Received Today automatically opens Quest Progress too.</li>
                    <li><span class="subheading">Missing Equipment</span> now includes apologetic message for Orb of Rebirthers (feature is unhelpful for them but that might change).</li>
                </ul>
            </li>
            <li>Documentation:
                <ul>
                    <li>Updated Possible Future Features</li>
                    <li>Added Version History</li>
                </ul>
            </li>
        </ul></dd>
        <dt>1.1 - initial release <span class="date">2014-03-27</span></dt>
        <dd><ul>
            <li>Features:
                <ul>
                    <li class="subheading">Unallocated Points</li>
                    <li class="subheading">Habit History</li>
                    <li class="subheading">Quest Progress</li>
                    <li class="subheading">Missing Equipment</li>
                    <li class="subheading">Drops Received Today</li>
                    <li class="subheading">Tasks That Have Not Been Tagged</li>
                </ul>
            </li>
            <li>Documentation:
                <ul>
                    <li>Privacy and security notes (also related comments within the code)</li>
                    <li>What's On This Page? (descriptions of each feature)</li>
                    <li>Possible Future Features</li>
                    <li>Suspected Bugs (no support for old browsers; mobile support unknown)</li>
                    <li>Help and Contact Details</li>
                </ul>
            </li>
        </ul></dd>
    </dl>
    <div class="showHideToggle closer" data-target="versionChanges" data-scrolltotop="true">close version history <span class="lowlight">(or click the version number again to close)</span></div>
    <hr />
</div><!-- end of div id="versionChanges" -->


<div id="DASHBOARD"></div>
<div id="TOC"></div>
<div id="MAIN"></div>


<div id="documentationAndForm">
   <p>This page shows you certain information from your <a
   href="https://habitrpg.com/">HabitRPG</a> account. You can read the
   full list below, or just enter your details and try it out.</p>

    <iframe src="null.htm" id="formPasswdSaveFix" name="formPasswdSaveFix" style="display:none"></iframe><!-- DAMN YOU CHROME!! DAMN YOU!!!! http://stackoverflow.com/a/9116737 -->
    <form id="userApiDetailsForm" method="POST" action="" target="formPasswdSaveFix">
        <fieldset>
            <legend><span class="highlight">Enter your HabitRPG API details</span>
            (from the <a href="https://habitrpg.com/#/options/settings/api">Settings
             -&gt; API page</a>)
            </legend>
            <label for="userId"><span>User ID</span>
                <input type="text" name="userId" id="userId" />
            </label>
            <label for="apiToken"><span>API Token</span>
                <input type="password" name="apiToken" id="apiToken" />
            </label>
            <input type="submit" value="Fetch My Data" />
            <p class="highlight">Privacy and security notes:</p>
            <ul>
            <li>Your API Token is a password - do not share it with anyone,
            not even the maintainer of this page if you are seeking help.</li>
            <li>When you enter your User ID and API Token here and click
            "Fetch My Data", your ID and Token are sent to HabitRPG's servers.
            They are not sent anywhere else.
            To confirm that, you can ask someone who knows the JavaScript
            programming language to examine the source of this page.</li>
            <li>This page does not save your User ID and API Token to any
            location, but your browser might, if it has been configured to
            save form and password information. If you are using this page
            on a shared computer, you should clear any data that the browser
            has saved.</li>
            <li>You cannot damage your HabitRPG account in any way by using
            this page. It fetches data from HabitRPG's servers but it
            does not make any other kind of request. Your account will not be
            changed by this.</li>
            <li>You cannot view anyone else's data by using this page.<!-- XXX_LATER:  add this if more party code is put in (and improve wording): "except the most basic details (e.g., name) that you can already see on the party page" --></li>
            <li>To clear your data, reload the page.</li>
            </ul>
        </fieldset>
    </form>


    <div>
       <h2>What's On This Page?</h2>
       <ul>
            <li><span class="subheading">Task Overview</span>: A table listing your habits, dailies, and to-dos, with their <a href="http://habitrpg.wikia.com/wiki/Advanced_Options">attributes</a> and <a href="http://habitrpg.wikia.com/wiki/Task_Value">colours, values, and magnitudes</a> (value and magnitude are useful for choosing tasks to cast skills on). Completed to-dos are not shown; completed dailies are. At the bottom of this section, you will find one randomly-selected item from your to-do list. Re-fetch your data to see a different random to-do.</li>
            <li><span class="subheading">Task Statistics</span>: How many habits, dailies, to-dos, and rewards you have in total, and how many are assigned to each <a href="http://habitrpg.wikia.com/wiki/Advanced_Options">attribute</a>. If you have task-based <a href="http://habitrpg.wikia.com/wiki/Automatic_Allocation">auto-allocation</a> turned on, this section will also show your <span class="subheading">Training Points</span>.</li>
            <li><span class="subheading">Tasks Untagged</span>: If you have any habits, dailies, to-dos, or rewards that have not been <a href="http://habitrpg.wikia.com/wiki/Tags">tagged</a> they will be listed. This will be useful to you only if you prefer to tag all your tasks and are looking for any you have missed.</li>
            <li><span class="subheading">Habit History</span>: This shows some of the dates and times you recently clicked on your habits. But note the disclaimer you'll see at the top of the list! Most of your clicks can not be shown.</li>
            <li><span class="subheading">Dailies Incomplete</span>: A list of dailies scheduled for today that you have not yet completed, and the estimated damage you will take from each one. It also has a separate list of <a href="http://habitrpg.wikia.com/wiki/Dailies#Grey_Dailies">grey dailies</a> that have not been completed (you don't need to do those today, but you might want to for extra rewards).</li>
            <li><span class="subheading">To-Dos with Dates</span>: A list of all to-dos that have been given due dates, sorted by date. If there are any to-dos due today or overdue, a red tile will appear in the dashboard to tell you how many there are.</li>
            <li><span class="subheading">Drops Received Today</span>: The number of <a href="http://habitrpg.wikia.com/wiki/Drops">drops</a> you have received so far today will be shown, along with your <a href="http://habitrpg.wikia.com/wiki/Drops#Drop-Cap">drop-cap</a>.</li>
            <li><span class="subheading">Quest Progress</span>: If you are on a boss or collection <a href="http://habitrpg.wikia.com/wiki/Quests">quest</a>, you'll see an estimate of how much progress you have made so far today.</li>
            <li><span class="subheading">Damage from Dailies</span>: This <span class="highlight">estimates</span> the amount of damage you will take at the end of the day if you do not complete any more dailies today. It includes additional damage from a <a href="http://habitrpg.wikia.com/wiki/Quests">quest</a> <a href="http://habitrpg.wikia.com/wiki/Boss">boss</a>. Be cautious about relying on these estimates if you are low on health! Please read the warning in that section (click its "show explanation" link).</li>
            <li><span class="subheading">Stats and Streaks Backup</span>: A plain-text view of information that you might need to <a href="http://habitrpg.wikia.com/wiki/Settings">restore your stats</a> and <a href="http://habitrpg.wikia.com/wiki/Streaks">your dailies' streaks</a> if you die through no fault of your own. This information is available <span class="highlight">only before death</span>, so you might wish to copy the information every few days.</li>
            <li><span class="subheading">Unallocated Points</span>: If you have any <a href="http://habitrpg.wikia.com/wiki/Character_Attributes">unallocated points</a>, you'll see how many and a link to the HabitRPG <a href="https://habitrpg.com/#/options/profile/stats">Profile -&gt; Stats page</a> so you can allocate them.</li>
            <li><span class="subheading">Missing Equipment</span>: If you have <a href="http://habitrpg.wikia.com/wiki/Death_Mechanics">died</a> and lost equipment, that equipment will be listed, along with the class that it belongs to. This is to help you buy it back, if you choose to do so.</li>
            <li><span class="subheading">Current Appearance and Gear</span>: This lists the <a href="http://habitrpg.wikia.com/wiki/Equipment">equipment</a> you are wearing (battle gear and costume), your <a href="http://habitrpg.wikia.com/wiki/Profile#Avatar">avatar's appearance settings</a> (skin colour, hair, etc), and your <a href="http://habitrpg.wikia.com/wiki/Pets">pet</a> and <a href="http://habitrpg.wikia.com/wiki/Mounts">mount</a>. This lets you easily record an appearance that you especially like or a set of battle gear that gives you useful stats (e.g., you could copy and paste this section to a text file).</li>
            <li><span class="subheading">Equipment Recommendations</span>: This displays your best equipment with features that help you choose the right gear for maximising specific attributes (for example, to maximise INT and CON before casting a healing spell).</li>
       </ul>
        <p>Those items will not be shown if they are not relevant to your account (e.g., if you have no untagged tasks, you will not see the untagged tasks section).</p>

       <h2>Possible Future Features</h2>
       <ul>
            <li><em>This week:</em> A few new features and then I'll update this list properly with all the features people have suggested recently.</li>
            <li><em>Probably:</em> <span class="subheading">Pie Charts</span>: <a href="http://habitrpg.wikia.com/wiki/Thread:11457">join the discussion</a></li>
            <li><em>Maybe:</em> <span class="subheading">Support for Markdown</span>: <a href="http://habitrpg.wikia.com/wiki/Markdown_Cheat_Sheet">Markdown</a> also looks bad, but support for it might not be easy to implement. Apologies again.</li>
            <li><em>Maybe:</em> <span class="subheading">Missing Equipment for Orb of Rebirthers</span>: do something to make the feature more useful for them.</li>
            <li><span class="subheading">Other Stuff?</span>: Send me ideas! Contact details are below.</li>
       </ul>

       <h2>Known Bugs</h2>
       <p>Internet Explorer will produce odd results if you use the "Re-Fetch Data" button. Reloading the page will fix the problem. Avoid using that button. Avoiding Internet Explorer will also work.</p>
       <p>This page will not work correctly on old browsers because it uses modern website features and relies on compliance to standards (both can be lacking in old browsers). <a href="http://browsehappy.com/">Updating your browser is important for general safety on the internet!</a> If you have upgraded your browser to the latest version and are still having problems, please tell me! Contact details are below.</p>
       <p>Regardless of what bugs there might be, this page cannot damage your account. It does not contain any code that could result in any changes being made on HabitRPG.</p>

       <h2>Help and Contact Details</h2>
       <p>This page has been created by <a href="http://habitrpg.wikia.com/wiki/User:LadyAlys">Alys</a> (a.k.a. Alice Harris). If you have questions, problems, or suggestions, you're welcome to contact me, although I cannot guarantee that I'll always be able to spend a lot of time on this. Email to <a href="mailto:lady_alys@oldgods.net">lady_alys@oldgods.net</a> is the best way to reach me, or you can comment on <a href="http://habitrpg.wikia.com/wiki/User_blog:LadyAlys/HabitRPG_Unofficial_User_Data_Display">this wiki blog post</a>.</p>

        <p>If you have general questions about HabitRPG, post them to <a href="https://habitrpg.com/#/options/groups/tavern">Tavern Talk</a> or <a href="http://habitrpg.wikia.com/wiki/Board:The_Quarters_-_Q_%26_A">The Quarters - Q & A board</a>.</p>
    </div>

    <div id="documentationAndFormClose" class="showHideToggle closer" data-target="documentationAndForm" data-resettoggletext="documentationAndFormToggle">hide documentation</div>
</div><!-- end of div id="documentationAndForm" -->


</div><!-- end of div id="innerBody" -->
</body>
</html>
